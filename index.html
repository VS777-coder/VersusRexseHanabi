<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>真・ハナビ＆バーサス 設定推測（完全固定版）</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 950px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #1a237e; border-bottom: 3px solid #b71c1c; padding-bottom: 10px; margin-bottom: 20px; }
        .notice { background: #fffde7; border: 1px solid #fbc02d; padding: 10px; font-size: 0.85em; color: #5d4037; border-radius: 5px; margin-bottom: 20px; }
        .result-box { background: #fafafa; border: 2px solid #1a237e; padding: 20px; border-radius: 10px; }
        .bar-container { display: flex; height: 40px; margin-top: 15px; border-radius: 6px; overflow: hidden; border: 1px solid #222; background: #ddd; }
        .bar { display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; text-shadow: 1px 1px 2px #000; transition: width 0.5s ease; }
        .s1 { background-color: #1e88e5; } .s2 { background-color: #43a047; } .s5 { background-color: #fdd835; color: #333; text-shadow: none; } .s6 { background-color: #e53935; }
    </style>
</head>
<body>

<div class="container">
    <h1>真・設定推測ロジック</h1>
    <div class="notice">
        ● <strong>新ハナビ</strong>：ユーザー指定の風鈴A/B、氷A/B、RTハズレを反映済み。<br>
        ● <strong>バーサスリヴァイズ</strong>：ご提示いただいたID:0〜18の全定義（probs、weight）を慎重に反映済み。
    </div>

    <div class="result-box">
        <h2 id="machine-display" style="margin:0 0 10px 0; color:#1a237e;">解析中...</h2>
        <div id="result-text" style="font-size: 1.1em; letter-spacing: 1px;"></div>
        <div class="bar-container" id="result-bar"></div>
    </div>
</div>

<script>
/**
 * 完全固定定義：VERSUS_CONFIG (ご提示の数値をそのまま反映)
 */
const VERSUS_CONFIG = [
    { index: 0, id: "total_bonus", name: "ボーナス合算", active: false, weight: 0.0, probs: {1: 164.3, 2: 155.3, 5: 147.9, 6: 138.8} },
    { index: 1, id: "bb", name: "ビックボーナス合算", active: true, weight: 1.0, probs: {1: 292.6, 2: 284.9, 5: 275.4, 6: 264.3} },
    { index: 2, id: "x_bb", name: "Ｘビッグボーナス", active: false, weight: 0.0, probs: {1: 585.1, 2: 569.9, 5: 550.7, 6: 528.5} },
    { index: 3, id: "seven_bb", name: "７ビッグボーナス", active: false, weight: 0.0, probs: {1: 585.1, 2: 569.9, 5: 550.7, 6: 528.5} },
    { index: 4, id: "rb", name: "レギュラーボーナス", active: true, weight: 1.6, probs: {1: 374.5, 2: 341.3, 5: 319.7, 6: 292.6} },
    { index: 5, id: "bell_total", name: "ベル合算", active: false, weight: 0.0, probs: {1: 7.2, 2: 7.1, 5: 6.9, 6: 6.8} },
    { index: 6, id: "bell_a", name: "ベルＡ", active: true, weight: 1.2, probs: {1: 10.9, 2: 10.7, 5: 10.5, 6: 10.2} },
    { index: 7, id: "bell_b", name: "ベルＢ", active: true, weight: 0.8, probs: {1: 20.9, 2: 21.2, 5: 20.3, 6: 20.6} },
    { index: 8, id: "suika_total", name: "スイカ合算", active: false, weight: 0.0, probs: {1: 55.5, 2: 53.4, 5: 54.4, 6: 52.3} },
    { index: 9, id: "suika_a", name: "スイカＡ", active: true, weight: 1.0, probs: {1: 74.5, 2: 70.6, 5: 72.5, 6: 68.8} },
    { index: 10, id: "suika_b", name: "スイカＢ", active: true, weight: 1.0, probs: {1: 218.5, 2: 219.2, 5: 217.9, 6: 218.1} },
    { index: 11, id: "cherry_total", name: "チェリー合算", active: false, weight: 0.0, probs: {1: 38.2, 2: 38.9, 5: 36.7, 6: 37.3} },
    { index: 12, id: "cherry_a", name: "チェリーＡ", active: false, weight: 0.0, probs: {1: 119.2, 2: 119.2, 5: 119.2, 6: 118.9} },
    { index: 13, id: "cherry_b", name: "チェリーＢ", active: true, weight: 1.0, probs: {1: 56.2, 2: 57.7, 5: 53.1, 6: 54.4} },
    { index: 14, id: "vc_miss", name: "バーサスチャンスはずれ", active: true, weight: 1.2, probs: {1: 5.0, 2: 4.9, 5: 4.6, 6: 4.5} },
    { index: 15, id: "vg_miss", name: "バーサスゲームはずれ", active: true, weight: 1.6, probs: {1: 10.1, 2: 9.4, 5: 8.7, 6: 8.1} },
    { index: 16, id: "bb_bell_total", name: "ビッグ中ベル", active: false, weight: 0.0, probs: {1: 1.0, 2: 1.0, 5: 1.0, 6: 1.0} },
    { index: 17, id: "cb_hit", name: "チェリー＋ベル揃い", active: true, weight: 1.0, probs: {1: 11.1, 2: 8.9, 5: 11.1, 6: 8.9} },
    { index: 18, id: "cb_miss", name: "チェリー＋ベルはずれ", active: true, weight: 0.8, probs: {1: 256.0, 2: 128.0, 5: 256.0, 6: 128.0} }
];

/**
 * 完全固定定義：HANABI_CONFIG (新ハナビ・真公表値)
 */
const HANABI_CONFIG = [
    { name: "BIG", id: "bb", calc: true, weight: 1.0, probs: {1:277.7, 2:268.6, 5:256.0, 6:248.2} },
    { name: "REG", id: "rb", calc: true, weight: 1.0, probs: {1:356.2, 2:331.0, 5:306.2, 6:280.1} },
    { name: "風鈴Ａ", id: "ba", calc: true, weight: 1.0, probs: {1:15.3, 2:14.9, 5:14.5, 6:14.1} },
    { name: "風鈴Ｂ", id: "bb_b", calc: true, weight: 1.0, probs: {1:15.3, 2:15.6, 5:15.3, 6:15.1} },
    { name: "氷Ａ", id: "ia", calc: true, weight: 1.0, probs: {1:52.9, 2:53.5, 5:49.6, 6:50.8} },
    { name: "氷Ｂ", id: "ib", calc: true, weight: 1.0, probs: {1:1638.4, 2:1638.4, 5:1638.4, 6:1638.4} },
    { name: "VCハズレ", id: "vc", calc: true, weight: 1.0, probs: {1:6.0, 2:5.8, 5:5.3, 6:5.1} },
    { name: "VGハズレ", id: "vg", calc: true, weight: 1.0, probs: {1:13.4, 2:12.4, 5:10.1, 6:9.5} }
];

/**
 * 尤度計算エンジン (変更なし)
 */
function calculateLikelihood(n, k, probs) {
    let res = {};
    Object.keys(probs).forEach(s => {
        const p = 1.0 / probs[s];
        res[s] = k * Math.log(p) + (n - k) * Math.log(1 - p);
    });
    return res;
}

/**
 * 推測ロジック実行
 */
function execute(target, data) {
    let totalLogL = {1: 0, 2: 0, 5: 0, 6: 0};
    const config = target === "HANABI" ? HANABI_CONFIG : VERSUS_CONFIG;

    config.forEach(item => {
        if (item.active !== false && item.calc !== false && data[item.id]) {
            const l = calculateLikelihood(data[item.id].g, data[item.id].h, item.probs);
            Object.keys(totalLogL).forEach(s => totalLogL[s] += l[s] * (item.weight || 1.0));
        }
    });

    const maxL = Math.max(...Object.values(totalLogL));
    const exps = {};
    let sum = 0;
    Object.keys(totalLogL).forEach(s => {
        exps[s] = Math.exp(totalLogL[s] - maxL);
        sum += exps[s];
    });
    return Object.keys(exps).map(s => ({ s: s, p: (exps[s] / sum) * 100 }));
}

// --- 実戦テストデータ (例: 新ハナビ 3651G) ---
const testData = {
    bb: {g: 3651, h: 11}, rb: {g: 3651, h: 11},
    ba: {g: 3651, h: 261}, bb_b: {g: 3651, h: 244},
    ia: {g: 3651, h: 69}, vc: {g: 164, h: 21}, vg: {g: 227, h: 16}
};

const finalRes = execute("HANABI", testData);

// レンダリング
document.getElementById('machine-display').innerText = "新ハナビ 解析結果";
document.getElementById('result-text').innerHTML = finalRes.map(r => `設定${r.s}: <strong>${r.p.toFixed(1)}%</strong>`).join(' | ');
document.getElementById('result-bar').innerHTML = finalRes.map(r => `<div class="bar s${r.s}" style="width: ${r.p}%">${r.p > 5 ? '設定'+r.s : ''}</div>`).join('');
</script>
</body>
</html>