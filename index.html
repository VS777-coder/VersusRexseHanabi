<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>✨ VERSUS & HANABI ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Share+Tech+Mono&display=swap');
        body { background-color: #0d0f14; color: #ffffff; font-family: 'Inter', sans-serif; height: 100dvh; width: 100vw; padding: 12px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .kawaii-title { font-family: 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(45deg, #ff7eb3, #ff758c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255,126,179,0.3)); }
        .main-btn { background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); border-radius: 20px; box-shadow: 0 10px 20px rgba(255,0,128,0.4); border: 2px solid #ffffff; transition: transform 0.1s; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2; }
        .main-btn:active { transform: scale(0.95); }
        .result-card { background-color: #161b22; border-radius: 16px; padding: 14px; border: 1px solid #30363d; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin-bottom: 8px; }
        .bar-bg { background-color: #0d1117; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 4px; border: 1px solid #21262d; }
        .bar-fill { height: 100%; width: 0%; transition: width 1.2s cubic-bezier(0.19, 1, 0.22, 1); }
        .future-log { background-color: #000000; border: 1px solid #ff758c; border-radius: 8px; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 10px; color: #fbcfe8; height: 320px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 8px; box-shadow: inset 0 0 10px rgba(255,117,140,0.1); }
        .api-input { background-color: #161b22; color: #ffffff; border-radius: 99px; padding: 8px 16px; font-size: 12px; width: 100%; border: 1px solid #30363d; outline: none; }
    </style>
</head>
<body>
    <div class="text-center shrink-0 mb-4">
        <div class="text-xl font-black kawaii-title tracking-tighter">✨ VERSUS & HANABI ✨</div>
        <p class="text-[10px] text-pink-300 font-bold uppercase">みおちゃん専用 Rev 1.0.15 (Debug Filter)</p>
    </div>

    <div class="w-full shrink-0 mb-4 max-w-md mx-auto">
        <label for="file-input" class="main-btn w-full py-4 text-white font-black text-2xl flex items-center justify-center cursor-pointer text-center">ユニメモ解析<br>実行</label>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <div class="w-full max-w-md mx-auto result-card">
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-cyan-400"><span>設定1</span><span id="p1">---</span></div><div class="bar-bg"><div id="b1" class="bar-fill bg-cyan-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-yellow-400"><span>設定2</span><span id="p2">---</span></div><div class="bar-bg"><div id="b2" class="bar-fill bg-yellow-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-green-400"><span>設定5</span><span id="p5">---</span></div><div class="bar-bg"><div id="b5" class="bar-fill bg-green-400"></div></div></div>
        <div><div class="flex justify-between text-xs font-bold text-red-500"><span>設定6</span><span id="p6">---</span></div><div class="bar-bg"><div id="b6" class="bar-fill bg-red-500"></div></div></div>
    </div>

    <div id="log" class="future-log w-full max-w-md mx-auto">READY...</div>

    <div class="w-full max-w-md mx-auto shrink-0 pb-2 flex gap-2">
        <input type="password" id="api-key" class="api-input flex-grow" placeholder="API KEY (VISION API)">
        <button id="save-key" class="bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-[10px]">SAVE</button>
    </div>

    <script>
        // 定義されたインデックスマップ
        const INDEX_MAP = [
            { name: "総ボーナス合算" }, // 0
            { name: "BIG合算" },       // 1
            { name: "ドンBB" },        // 2
            { name: "赤七BB" },        // 3
            { name: "RB" },            // 4
            { name: "風鈴合算" },      // 5
            { name: "風鈴A" },         // 6
            { name: "風鈴B" },         // 7
            { name: "氷合算" },        // 8
            { name: "氷A" },           // 9
            { name: "氷B" },           // 10
            { name: "チェリー合算" },   // 11
            { name: "チェリーA1" },     // 12
            { name: "チェリーA2" },     // 13
            { name: "チェリーB" },      // 14
            { name: "HC中ハズレ" },     // 15
            { name: "HG中ハズレ" },     // 16
            { name: "風鈴中段揃い" },   // 17
            { name: "斜め風鈴" }        // 18
        ];

        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerText += `\n> ${msg}`;
            log.scrollTop = log.scrollHeight;
        }

        async function analyze(file) {
            const apiKeyInput = document.getElementById('api-key');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) { 
                alert('APIキーが入力されていません！下の入力欄に入れてSAVEボタンを押してください。'); 
                return; 
            }

            const logBox = document.getElementById('log');
            logBox.innerText = ">> STARTING DEBUG FILTER (Rev 1.0.15)...";
            addLog("画像読み込み中...");
            
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                try {
                    addLog("APIリクエスト送信...");
                    const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                        method: 'POST', body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    addLog(`レスポンス受信: Status ${res.status}`);
                    
                    if (res.status !== 200) return;

                    const json = await res.json();
                    if (json.error) {
                        addLog(`API ERROR: ${json.error.message}`);
                        return;
                    }
                    
                    const ann = json.responses[0]?.textAnnotations;
                    if (!ann) return addLog("ERROR: 文字が見つかりませんでした。");
                    
                    const rawWords = ann.slice(1);
                    addLog(`\n--- (1) API生データ (検出数: ${rawWords.length}) ---`);
                    rawWords.forEach((w, i) => {
                         const v = w.boundingPoly.vertices;
                         const y = v && v[0] ? v[0].y : '?';
                         addLog(`[Word ${i}] Y:${y} "${w.description}"`);
                    });

                    // 1. 動的しきい値計算
                    const avgH = rawWords.map(w => Math.abs(w.boundingPoly.vertices[2].y - w.boundingPoly.vertices[0].y)).reduce((a,b)=>a+b,0) / rawWords.length;
                    const dynamicThreshold = avgH * 0.6;
                    addLog(`\n[INFO] 動的しきい値: ${dynamicThreshold.toFixed(2)}px (文字平均高: ${avgH.toFixed(1)}px)`);

                    // 2. 行結合
                    let rows = [];
                    rawWords.forEach(word => {
                        const y = word.boundingPoly.vertices[0].y;
                        let found = rows.find(r => Math.abs(r.y - y) < dynamicThreshold);
                        if (found) found.words.push(word); else rows.push({ y: y, words: [word] });
                    });
                    const sortedLines = rows.sort((a, b) => a.y - b.y).map(r => {
                        return { y: Math.round(r.y), text: r.words.sort((a, b) => a.boundingPoly.vertices[0].x - b.boundingPoly.vertices[0].x).map(w => w.description).join(" ") };
                    });

                    addLog(`\n--- (2) 結合データ (${sortedLines.length}行) ---`);
                    sortedLines.forEach((r, idx) => {
                        addLog(`[Row ${idx}] Y:${r.y} | ${r.text}`);
                    });

                    // 3. 開始位置フィルタリング
                    let startY = 0;
                    // "総 プレイ 数" を含む行を探す (正規表現でスペース柔軟対応)
                    const startRow = sortedLines.find(r => /総\s*プレイ\s*数/.test(r.text));
                    if (startRow) {
                        startY = startRow.y;
                        addLog(`\n[INFO] 開始位置特定: "総プレイ数" found at Y:${startY}`);
                        addLog(`       -> Y:${startY} より上の行は無視します。`);
                    } else {
                        addLog(`\n[WARNING] "総プレイ数" が見つかりません。全行を対象にします。`);
                    }

                    // 4. リスト抽出 (List P & List C) with Filter
                    let probList = [];
                    let countList = [];

                    sortedLines.forEach(line => {
                        // フィルタリング実行
                        if (line.y < startY) return;

                        const text = line.text;
                        
                        // 確率行の検出 (1/数値 または 1/-)
                        const probMatch = text.match(/1\s*\/\s*([\d,.]+|[\-–—])/);
                        if (probMatch) {
                            probList.push(text);
                        }

                        // 回数行の検出 (数値 回)
                        const countMatch = text.match(/([\d,]+)\s*回/);
                        if (countMatch) {
                            countList.push(text);
                        }
                    });

                    addLog(`\n--- (3) 抽出結果 (P:${probList.length}行 / C:${countList.length}行) ---`);

                    // 5. マッピング出力
                    addLog("\n--- 今回の結果 (Index 0-18) ---");
                    
                    for (let i = 0; i <= 18; i++) {
                        const item = INDEX_MAP[i];
                        
                        // 確率の抽出
                        let probVal = "取得失敗";
                        if (i < probList.length) {
                            const pText = probList[i];
                            const pMatch = pText.match(/1\s*\/\s*([\d,.]+|[\-–—])/);
                            if (pMatch) probVal = `1/${pMatch[1]}`;
                        }

                        // 回数の抽出
                        let countVal = "取得失敗";
                        if (i < countList.length) {
                            const cText = countList[i];
                            const cMatch = cText.match(/([\d,]+)\s*回/);
                            if (cMatch) countVal = `${cMatch[1]}回`;
                        }

                        addLog(`[${i}] ${item.name} | 回数: ${countVal} | 確率: ${probVal}`);
                    }

                } catch(e) { addLog("SYSTEM ERROR: " + e.message); }
            };
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('v_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
        });
        document.getElementById('save-key').onclick = () => { 
            const val = document.getElementById('api-key').value.trim();
            localStorage.setItem('v_key', val); 
            document.getElementById('api-key').value = val;
            alert('API KEY SAVED!'); 
        };
        const fileInput = document.getElementById('file-input');
        fileInput.onclick = (e) => { e.target.value = null; };
        fileInput.onchange = (e) => { if(e.target.files[0]) analyze(e.target.files[0]); };
    </script>
</body>
</html>