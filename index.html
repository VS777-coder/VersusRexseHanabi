<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>みおちゃん専用 v1.1.18 SMART</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@900&display=swap');
        body { background-color: #0f1219; color: #ffffff; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; padding: 12px; box-sizing: border-box; }
        .cool-title { font-family: 'Noto Sans JP'; font-size: 24px; background: linear-gradient(to right, #60a5fa, #f472b6, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; font-weight: 900; }
        .result-card { background: #1e293b; border-left: 4px solid #ec4899; padding: 8px 12px; margin-bottom: 6px; border-radius: 4px; }
        .console-box { background: #000; color: #4ade80; font-family: monospace; font-size: 10px; padding: 8px; border-radius: 4px; flex-grow: 1; overflow-y: auto; border: 1px solid #334155; }
    </style>
</head>
<body>
    <div class="mb-4">
        <div class="cool-title">バーサス ＆ 新ハナビ</div>
        <p class="text-center text-pink-500 text-xs font-bold">Revision 1.1.18 (Context Logic)</p>
    </div>

    <input type="file" id="file-input" class="hidden" accept="image/*">
    <label for="file-input" class="bg-pink-700 text-white text-center py-3 rounded-full font-bold mb-4 cursor-pointer shadow-lg active:scale-95 transition-all">画像を解析する</label>

    <div id="results" class="mb-4 space-y-2 overflow-y-auto max-h-60"></div>
    <div id="log" class="console-box">解析結果がここに表示されます。</div>

    <div class="mt-auto pt-2 flex gap-2">
        <input type="password" id="api-key" class="bg-gray-800 text-white text-xs p-2 rounded flex-grow" placeholder="API KEY">
        <button id="save-key" class="bg-gray-600 px-4 rounded text-xs">SET</button>
    </div>

    <script>
        const resultsArea = document.getElementById('results');
        const logArea = document.getElementById('log');
        const keyInput = document.getElementById('api-key');

        if(localStorage.getItem('v_key')) keyInput.value = localStorage.getItem('v_key');
        document.getElementById('save-key').onclick = () => { localStorage.setItem('v_key', keyInput.value); alert('SAVED'); };

        function extractDenominator(text) {
            // 「1 / [回数] [分母]」の並びから分母(最後)の数値を抜く
            const m = text.match(/1\s*\/\s*[\d,.]+\s+([\d,.]+)/) || text.match(/1\s*\/\s*([\d,.]+)/);
            return m ? m[1] : null;
        }

        async function analyze(file) {
            resultsArea.innerHTML = "";
            logArea.innerText = "解析中...\n";
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${keyInput.value}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] })
                });
                const data = await res.json();
                const ann = data.responses[0].textAnnotations;
                if(!ann) return;

                // 1. まず行にまとめる (安定のTH 30)
                const items = ann.slice(1).map(a => ({ text: a.description, x: a.boundingPoly.vertices[0].x, y: a.boundingPoly.vertices[0].y }));
                items.sort((a,b) => a.y - b.y);
                let rows = []; let cur = [items[0]];
                for(let i=1; i<items.length; i++) {
                    if(Math.abs(items[i].y - cur[0].y) < 30) cur.push(items[i]);
                    else { rows.push(cur.sort((a,b)=>a.x-b.x).map(it=>it.text).join(' ')); cur=[items[i]]; }
                }
                rows.push(cur.sort((a,b)=>a.x-b.x).map(it=>it.text).join(' '));

                // 2. 構造的パース (名前が消えても順番で特定)
                let context = "";
                rows.forEach(line => {
                    logArea.innerText += line + "\n";
                    let label = ""; let val = extractDenominator(line);
                    
                    if(line.includes("風鈴") || line.includes("ベル")) context = "小役";
                    
                    // 苗字欠損救済ロジック
                    if(line.match(/^A\s+/) || line.match(/^A1\s+/)) label = "A";
                    else if(line.match(/^B\s+/)) label = "B";
                    else if(line.includes("合算")) label = "合算";

                    if(label && val) {
                        const card = document.createElement('div');
                        card.className = "result-card";
                        card.innerHTML = `<span class="text-pink-400 font-bold">${context}${label}</span>: <span class="text-white text-lg">1 / ${val}</span>`;
                        resultsArea.appendChild(card);
                    }
                });
            };
        }

        document.getElementById('file-input').onchange = (e) => analyze(e.target.files[0]);
    </script>
</body>
</html>