<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>みおの安全性検証 1.1.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        body { background-color: #0d0f14; color: #ffffff; font-family: sans-serif; height: 100dvh; width: 100vw; padding: 12px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .main-btn { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); border-radius: 12px; border: 2px solid #fff; }
        .graph-area { background-color: #161b22; border-radius: 16px; padding: 12px; height: 25vh; flex-shrink: 0; margin-bottom: 8px; border: 1px solid #30363d; }
        .debug-log { background-color: #000; border: 1px solid #00ffcc; border-radius: 12px; padding: 12px; font-family: 'Share Tech Mono', monospace; font-size: 10px; color: #00ffcc; height: 60vh; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; line-height: 1.2; box-shadow: inset 0 0 10px rgba(0,255,204,0.2); }
        .log-item { border-bottom: 1px solid #222; margin-bottom: 4px; padding-bottom: 2px; }
        .warn { color: #ff3e3e; font-weight: bold; }
        .info { color: #facc15; }
        .success { color: #4ade80; }
    </style>
</head>
<body>
    <div class="w-full shrink-0 mb-3 max-w-md mx-auto">
        <label for="file-input" class="main-btn w-full py-4 text-white font-black text-xl flex items-center justify-center text-center cursor-pointer">
            ユニメモ<br>安全性検証実行
        </label>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <div class="w-full max-w-md mx-auto graph-area flex flex-col justify-center items-center text-center">
        <p class="text-xs text-gray-400">現在「事実確認モード」です</p>
        <p class="text-lg font-bold text-indigo-400">設定推測はログ検証後に再開します</p>
    </div>

    <div id="debug-log" class="debug-log w-full max-w-md mx-auto">
        画像を選択して、数値抽出の「安全性」を確認してください。
    </div>

    <input type="password" id="api-key" class="hidden">

    <script>
        const MASTER_CONFIG = {
            "VERSUS": {
                name: "バーサスリヴァイズ",
                total: { key: "総\\s*プレイ\\s*数", label: "総プレイ数", type: "total" },
                bb: { key: "BB", label: "BB" },
                rb: { key: "RB", label: "RB" },
                ba: { key: "ベル\\s*A", label: "ベルA" },
                bb2: { key: "ベル\\s*B", label: "ベルB" },
                sa: { key: "スイカ\\s*A", label: "スイカA" },
                ca: { key: "チェリー\\s*A", label: "チェリーA" },
                cb: { key: "チェリー\\s*B", label: "チェリーB" },
                vc: { key: "チャンス\\s*中\\s*はずれ", label: "VCはずれ" },
                vg: { key: "GAME\\s*中\\s*はずれ", label: "VGはずれ" }
            },
            "HANABI": {
                name: "新ハナビ",
                total: { key: "総\\s*プレイ\\s*数", label: "総プレイ数", type: "total" },
                bb: { key: "BB", label: "BB" },
                rb: { key: "RB", label: "RB" },
                ba: { key: "A\\s+1", label: "風鈴A" },
                bb2: { key: "風鈴\\s*B", label: "風鈴B" },
                sa: { key: "氷\\s*A", label: "氷A" },
                ca2: { key: "チェリー\\s*A2", label: "チェリーA2" },
                cb: { key: "チェリー\\s*B", label: "チェリーB" },
                vc: { key: "チャレンジ\\s*中\\s*はずれ", label: "HCはずれ" },
                vg: { key: "GAME\\s*中\\s*はずれ", label: "HGはずれ" }
            }
        };

        let totalG = 0;

        function addLog(msg, type = '') {
            const logArea = document.getElementById('debug-log');
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function safeExtract(rawText) {
            document.getElementById('debug-log').innerHTML = '';
            const mode = (rawText.includes("ハナビ") || rawText.includes("ハナ ビ")) ? "HANABI" : "VERSUS";
            addLog(`■ 検出モード: ${mode}`, 'info');
            
            const config = MASTER_CONFIG[mode];
            totalG = 0;

            // 1. 総プレイ数の確定
            const totalMatch = rawText.match(new RegExp(`${config.total.key}[\\s\\S]{0,30}?([\\d,]+)G`));
            if (totalMatch) {
                totalG = parseInt(totalMatch[1].replace(/,/g, ''));
                addLog(`[SUCCESS] 総プレイ数確定: ${totalG} G`, 'success');
            } else {
                addLog(`[WARN] 総プレイ数が未検出です。検証精度が低下します。`, 'warn');
            }

            // 2. 各項目の安全性検証
            for (let id in config) {
                if (id === "total" || id === "name") continue;
                const item = config[id];
                const regex = new RegExp(`${item.key}[\\s\\S]{0,100}`);
                const m = rawText.match(regex);

                if (m) {
                    let segment = m[0].split('\n')[0]; // とりあえず1行分
                    addLog(`--------------------`);
                    addLog(`CHECK: [${item.label}]`);
                    addLog(`RAW: "${segment}"`);

                    // 【安全性検討】ラベルに含まれる数字を物理的に消去
                    const labelCleaned = segment.replace(new RegExp(item.key), '');
                    
                    // 「1 / XXX」形式の優先スキャン
                    const slashMatch = labelCleaned.match(/1\s*\/\s*([\d.]+)/);
                    const allNums = labelCleaned.match(/[\d,.]+/g);

                    if (allNums) {
                        const prob = slashMatch ? slashMatch[1] : (allNums.find(n => n.includes('.')) || allNums[allNums.length-1]);
                        const count = allNums.filter(n => !n.includes('.') && n !== "1").sort((a,b)=>b.length-a.length)[0] || "---";
                        
                        const pVal = parseFloat(prob.toString().replace(/,/g, ''));
                        const cVal = parseInt(count.toString().replace(/,/g, ''));

                        addLog(`  -> 候補: 確率 1/${pVal} | 回数 ${cVal}`);

                        // 数学的整合性チェック
                        if (totalG > 0 && !isNaN(pVal) && !isNaN(cVal)) {
                            const expectedTotal = pVal * cVal;
                            const diff = Math.abs(expectedTotal - totalG) / totalG;
                            if (diff < 0.1) {
                                addLog(`  -> [SAFE] 整合性確認OK (誤差 ${(diff*100).toFixed(1)}%)`, 'success');
                            } else {
                                addLog(`  -> [WARN] 整合性不一致: 回数×分母=${expectedTotal.toFixed(0)} (総プレイ数と${(diff*100).toFixed(1)}%乖離)`, 'warn');
                            }
                        }
                    } else {
                        addLog(`  -> [ERROR] 数値が検出できません`, 'warn');
                    }
                }
            }
        }

        if(localStorage.getItem('v_key')) document.getElementById('api-key').value = localStorage.getItem('v_key');
        
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                addLog("Vision API 接続中...", 'info');
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${document.getElementById('api-key').value}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const json = await res.json();
                const ann = json.responses[0]?.textAnnotations;
                if (ann) {
                    const items = ann.slice(1).map(a => ({ text: a.description, x: (a.boundingPoly.vertices[0].x + a.boundingPoly.vertices[2].x) / 2, y: (a.boundingPoly.vertices[0].y + a.boundingPoly.vertices[2].y) / 2 }));
                    
                    const maxY = Math.max(...items.map(it => it.y));
                    const minY = Math.min(...items.map(it => it.y));
                    const threshold = (maxY - minY) * 0.015;
                    addLog(`動的しきい値算出: ${threshold.toFixed(2)}px`, 'info');

                    items.sort((a, b) => a.y - b.y);
                    let rows = [], cur = [items[0]];
                    for (let i = 1; i < items.length; i++) {
                        if (Math.abs(items[i].y - cur[0].y) < threshold) cur.push(items[i]);
                        else { rows.push(cur); cur = [items[i]]; }
                    }
                    rows.push(cur);
                    const rawText = rows.map(r => r.sort((a, b) => a.x - b.x).map(it => it.text).join(' ')).join('\n');
                    safeExtract(rawText);
                }
            };
        };
    </script>
</body>
</html>