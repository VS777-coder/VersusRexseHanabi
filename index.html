<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>デバッグ版 1.1.15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d0f14; color: #ffffff; font-family: sans-serif; padding: 12px; }
        .debug-panel { background-color: #161b22; border: 2px solid #ff0080; border-radius: 16px; padding: 16px; width: 100%; max-width: 450px; margin: 0 auto; }
        .raw-viewer { background-color: #000; color: #00ff41; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 8px; margin-top: 12px; height: 30vh; overflow-y: auto; white-space: pre-wrap; border: 1px solid #333; }
        .main-btn { background: linear-gradient(135deg, #444 0%, #000 100%); border: 1px solid #ff0080; color: #ff0080; width: 100%; padding: 16px; border-radius: 12px; text-align: center; font-weight: bold; cursor: pointer; margin-bottom: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #ff0080; font-size: 11px; padding-bottom: 8px; border-bottom: 1px solid #333; }
        td { padding: 8px 0; font-size: 12px; border-bottom: 1px solid #222; }
        .total-g { font-size: 20px; font-weight: 900; color: #00f2ff; text-align: center; margin-bottom: 10px; border-bottom: 2px dashed #333; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="debug-panel">
        <label for="file-input" class="main-btn">デバッグ画像を選択 (Rev 1.1.15)</label>
        <input type="file" id="file-input" class="hidden" accept="image/*">

        <div id="total-display" class="total-g">G数: --- G</div>

        <table>
            <thead>
                <tr><th>項目</th><th>当選回数</th><th>確率分母</th></tr>
            </thead>
            <tbody id="buffer-table">
                </tbody>
        </table>

        <div id="raw-log" class="raw-viewer">待機中...</div>
    </div>

    <script>
        const CONFIG = {
            "HANABI": ["BB", "RB", "A\\s+1", "風鈴\\s*B", "氷\\s*A", "中\\s*はずれ"],
            "VERSUS": ["BB", "RB", "ベル\\s*A", "ベル\\s*B", "スイカ\\s*A", "中\\s*はずれ"]
        };

        async function processOCR(readerResult) {
            const apiKey = localStorage.getItem('v_key');
            const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                method: 'POST',
                body: JSON.stringify({ requests: [{ image: { content: readerResult.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                headers: { 'Content-Type': 'application/json' }
            });
            const json = await res.json();
            const ann = json.responses[0]?.textAnnotations;
            if (!ann) return;

            const items = ann.slice(1).map(a => ({ text: a.description, x: (a.boundingPoly.vertices[0].x + a.boundingPoly.vertices[2].x) / 2, y: (a.boundingPoly.vertices[0].y + a.boundingPoly.vertices[2].y) / 2 }));
            const maxY = Math.max(...items.map(it => it.y)), minY = Math.min(...items.map(it => it.y));
            const threshold = (maxY - minY) * 0.015;

            items.sort((a, b) => a.y - b.y);
            let rows = [], cur = [items[0]];
            for (let i = 1; i < items.length; i++) {
                if (Math.abs(items[i].y - cur[0].y) < threshold) cur.push(items[i]);
                else { rows.push(cur); cur = [items[i]]; }
            }
            rows.push(cur);
            const rawText = rows.map(r => r.sort((a, b) => a.x - b.x).map(it => it.text).join(' ')).join('\n');
            document.getElementById('raw-log').innerText = rawText;

            // 1. 総プレイ数抽出
            const gMatch = rawText.match(/([\d,]+)\s*G/i);
            const totalG = gMatch ? gMatch[1] : "未検出";
            document.getElementById('total-display').innerText = `G数: ${totalG} G`;

            // 2. モード判定
            const mode = (rawText.includes("ハナビ") || rawText.includes("ハナ ビ")) ? "HANABI" : "VERSUS";
            const targetKeys = CONFIG[mode];
            
            const tbody = document.getElementById('buffer-table');
            tbody.innerHTML = "";

            targetKeys.forEach(key => {
                const regex = new RegExp(`${key}[\\s\\S]{0,100}`);
                const match = rawText.match(regex);
                if (match) {
                    const segment = match[0];
                    const nums = (segment.match(/[\d,.]+/g) || []).map(n => n.replace(/,/g, ''));
                    
                    // 【指示】小数点がある方を分母にするロジック
                    let prob = nums.find(n => n.includes('.')) || "---";
                    let count = nums.find(n => !n.includes('.') && n !== "1" && n !== prob) || "---";

                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${key.replace('\\s+1','A')}</td><td>${count} 回</td><td>1/${prob}</td>`;
                    tbody.appendChild(tr);
                }
            });
        }

        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => processOCR(reader.result);
        };
    </script>
</body>
</html>