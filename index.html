<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>✨ VERSUS & HANABI ✨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Share+Tech+Mono&display=swap');
        body { background-color: #0d0f14; color: #ffffff; font-family: 'Inter', sans-serif; height: 100dvh; width: 100vw; padding: 12px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .kawaii-title { font-family: 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(45deg, #ff7eb3, #ff758c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255,126,179,0.3)); }
        .main-btn { background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); border-radius: 20px; box-shadow: 0 10px 20px rgba(255,0,128,0.4); border: 2px solid #ffffff; transition: transform 0.1s; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2; }
        .main-btn:active { transform: scale(0.95); }
        .result-card { background-color: #161b22; border-radius: 16px; padding: 14px; border: 1px solid #30363d; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin-bottom: 8px; }
        .bar-bg { background-color: #0d1117; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 4px; border: 1px solid #21262d; }
        .bar-fill { height: 100%; width: 0%; transition: width 1.2s cubic-bezier(0.19, 1, 0.22, 1); }
        .future-log { background-color: #000000; border: 1px solid #ff758c; border-radius: 8px; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 10px; color: #fbcfe8; height: 320px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 8px; box-shadow: inset 0 0 10px rgba(255,117,140,0.1); }
        .api-input { background-color: #161b22; color: #ffffff; border-radius: 99px; padding: 8px 16px; font-size: 12px; width: 100%; border: 1px solid #30363d; outline: none; }
    </style>
</head>
<body>
    <div class="text-center shrink-0 mb-4">
        <div class="text-xl font-black kawaii-title tracking-tighter">✨ VERSUS & HANABI ✨</div>
        <p class="text-[10px] text-pink-300 font-bold uppercase">みおちゃん専用 Rev 1.0.13 (Debug Mapping)</p>
    </div>

    <div class="w-full shrink-0 mb-4 max-w-md mx-auto">
        <label for="file-input" class="main-btn w-full py-4 text-white font-black text-2xl flex items-center justify-center cursor-pointer text-center">ユニメモ解析<br>実行</label>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <div class="w-full max-w-md mx-auto result-card">
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-cyan-400"><span>設定1</span><span id="p1">---</span></div><div class="bar-bg"><div id="b1" class="bar-fill bg-cyan-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-yellow-400"><span>設定2</span><span id="p2">---</span></div><div class="bar-bg"><div id="b2" class="bar-fill bg-yellow-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-green-400"><span>設定5</span><span id="p5">---</span></div><div class="bar-bg"><div id="b5" class="bar-fill bg-green-400"></div></div></div>
        <div><div class="flex justify-between text-xs font-bold text-red-500"><span>設定6</span><span id="p6">---</span></div><div class="bar-bg"><div id="b6" class="bar-fill bg-red-500"></div></div></div>
    </div>

    <div id="log" class="future-log w-full max-w-md mx-auto">READY...</div>

    <div class="w-full max-w-md mx-auto shrink-0 pb-2 flex gap-2">
        <input type="password" id="api-key" class="api-input flex-grow" placeholder="API KEY (VISION API)">
        <button id="save-key" class="bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-[10px]">SAVE</button>
    </div>

    <script>
        // 設定判別用コンフィグ（相対位置定義を追加）
        const MASTER_CONFIG = {
            "VERSUS": {
                name: "バーサスリヴァイズ",
                // バーサス用の相対位置は仮置き（ハナビと同様のロジックを想定）
                total: { name: "総プレイ数", key: "総\\s*プレイ\\s*数", type: "total" },
                bb:   { id: "bb", name: "ビックボーナス", anchor: "^BB", offset: 1, type: "bonus" },
                rb:   { id: "rb", name: "レギュラーボーナス", anchor: "^RB", offset: 1, type: "bonus" },
                ba:   { id: "ba", name: "ベルA", anchor: "ベル\\s*合算", offset: 4, type: "small" },
                bb_b: { id: "bb_b", name: "ベルB", anchor: "ベル\\s*合算", offset: 7, type: "small" },
                sa:   { id: "sa", name: "スイカA", anchor: "スイカ\\s*A", offset: 1, type: "small" },
                cb:   { id: "cb", name: "チェリーB", anchor: "チェリー\\s*B", offset: 1, type: "small" },
                vc:   { id: "vc", name: "VC中ハズレ", anchor: "チャンス.*中.*はずれ", offset: 1, type: "rt_vc" },
                vg:   { id: "vg", name: "VG中ハズレ", anchor: "GAME.*中.*はずれ", offset: 1, type: "rt_vg" },
                cbs:  { id: "cbs", name: "チェリー＋ベル揃い", anchor: "ベル.*揃い", offset: 1, type: "bb_detail" },
                cbh:  { id: "cbh", name: "チェリー＋ベルはずれ", anchor: "ベル.*はずれ", offset: 1, type: "bb_detail" }
            },
            "HANABI": {
                name: "新ハナビ",
                // ハナビ用：ユーザー分析に基づいた相対位置定義
                total: { name: "総プレイ数", key: "総\\s*プレイ\\s*数", type: "total" },
                bb:   { id: "bb", name: "ビックボーナス", anchor: "^BB", offset: 1, type: "bonus" },
                rb:   { id: "rb", name: "レギュラーボーナス", anchor: "^RB", offset: 1, type: "bonus" },
                ba:   { id: "ba", name: "風鈴A", anchor: "風鈴\\s*合算", offset: 4, type: "small" },
                bb_b: { id: "bb_b", name: "風鈴B", anchor: "風鈴\\s*合算", offset: 7, type: "small" },
                ice:  { id: "ice", name: "氷A", anchor: "氷\\s*A", offset: 1, type: "small" },
                // 氷Bは設定差特大だが頻度低いため、マッピングテスト用に追加
                ice_b:{ id: "ice_b", name: "氷B", anchor: "氷\\s*B", offset: 1, type: "small" },
                ca2:  { id: "ca2", name: "チェリーA2", anchor: "チェリー\\s*A2", offset: 1, type: "small" },
                cb:   { id: "cb", name: "チェリーB", anchor: "チェリー\\s*B", offset: 1, type: "small" },
                vc:   { id: "vc", name: "HC中ハズレ", anchor: "チャレンジ.*中.*はずれ", offset: 1, type: "rt_vc" },
                vg:   { id: "vg", name: "HG中ハズレ", anchor: "GAME.*中.*はずれ", offset: 1, type: "rt_vg" },
                nf:   { id: "nf", name: "斜め風鈴", anchor: "斜め.*揃い", offset: 1, type: "bb_detail" }
            }
        };

        function addLog(msg) {
            const log = document.getElementById('log');
            log.innerText += `\n> ${msg}`;
            log.scrollTop = log.scrollHeight;
        }

        async function analyze(file) {
            const apiKeyInput = document.getElementById('api-key');
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) { 
                alert('APIキーが入力されていません！下の入力欄に入れてSAVEボタンを押してください。'); 
                return; 
            }

            const logBox = document.getElementById('log');
            logBox.innerText = ">> STARTING DEBUG MAPPING (Rev 1.0.13)...";
            addLog("画像読み込み中...");
            
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                try {
                    addLog("APIリクエスト送信...");
                    const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                        method: 'POST', body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    addLog(`レスポンス受信: Status ${res.status}`);
                    
                    if (res.status !== 200) {
                        return;
                    }

                    const json = await res.json();
                    if (json.error) {
                        addLog(`API ERROR: ${json.error.message}`);
                        return;
                    }
                    
                    const ann = json.responses[0]?.textAnnotations;
                    if (!ann) return addLog("ERROR: 文字が見つかりませんでした。");
                    
                    const rawWords = ann.slice(1);
                    addLog(`\n--- (1) API生データ (検出数: ${rawWords.length}) ---`);
                    rawWords.forEach((w, i) => {
                         const v = w.boundingPoly.vertices;
                         const y = v && v[0] ? v[0].y : '?';
                         addLog(`[Word ${i}] Y:${y} "${w.description}"`);
                    });

                    // --- 動的しきい値計算 ---
                    const avgH = rawWords.map(w => Math.abs(w.boundingPoly.vertices[2].y - w.boundingPoly.vertices[0].y)).reduce((a,b)=>a+b,0) / rawWords.length;
                    const dynamicThreshold = avgH * 0.6; // 文字高さの6割（厳しめ設定）
                    addLog(`\n[INFO] 動的しきい値: ${dynamicThreshold.toFixed(2)}px (文字平均高: ${avgH.toFixed(1)}px)`);

                    // --- 結合処理 ---
                    let rows = [];
                    rawWords.forEach(word => {
                        const y = word.boundingPoly.vertices[0].y;
                        let found = rows.find(r => Math.abs(r.y - y) < dynamicThreshold);
                        if (found) found.words.push(word); else rows.push({ y: y, words: [word] });
                    });

                    // Y順ソート & 行内X順ソート
                    const sortedLines = rows.sort((a, b) => a.y - b.y).map(r => {
                        return { y: Math.round(r.y), text: r.words.sort((a, b) => a.boundingPoly.vertices[0].x - b.boundingPoly.vertices[0].x).map(w => w.description).join(" ") };
                    });

                    addLog(`\n--- (2) 結合データ (${sortedLines.length}行) ---`);
                    sortedLines.forEach((r, idx) => {
                        addLog(`[Row ${idx}] Y:${r.y} | ${r.text}`);
                    });

                    // --- 機種判定 ---
                    const rawContent = sortedLines.map(l => l.text).join("\n");
                    const mode = (rawContent.includes("ハナビ") || rawContent.includes("花火")) ? "HANABI" : "VERSUS";
                    addLog(`\nMODE: ${mode}`);
                    const config = MASTER_CONFIG[mode];

                    addLog("\n--- (3) 取り込み対象と取得データ ---");

                    // 1. 総プレイ数（これは直接検索）
                    const totalM = rawContent.match(new RegExp(`${config.total.key}[\\s\\S]{0,100}?([\\d,.]+)\\s*G`, 'i'));
                    if (totalM) {
                        addLog(`[DATA] ${config.total.name} -> ${totalM[0]} -> 値: ${totalM[1]}`);
                    } else {
                        addLog(`[MISS] ${config.total.name} (Direct Match Failed)`);
                    }

                    // 2. 相対位置によるマッピング
                    for (let id in config) {
                        const item = config[id];
                        if (id === "name" || item.type === "total") continue; // スキップ

                        let foundAnchor = false;
                        let targetRowIdx = -1;
                        let anchorText = "";

                        // アンカー行を探す
                        for (let i = 0; i < sortedLines.length; i++) {
                            if (new RegExp(item.anchor, 'i').test(sortedLines[i].text)) {
                                foundAnchor = true;
                                targetRowIdx = i + item.offset;
                                anchorText = sortedLines[i].text;
                                break;
                            }
                        }

                        if (foundAnchor) {
                            if (targetRowIdx < sortedLines.length) {
                                const targetRow = sortedLines[targetRowIdx];
                                const targetText = targetRow.text;
                                
                                // 数値抽出 (1/XX.X 形式)
                                let extractedVal = "なし";
                                const nums = targetText.match(/[\d,.]+/g);
                                if (nums) {
                                    // 小数点を含む、または1より大きい数字を探す（確率分母）
                                    const decimal = nums.find(n => n.includes('.') && parseFloat(n.replace(/,/g, '')) > 1.1);
                                    if (decimal) extractedVal = decimal;
                                    else {
                                        // 1 / XXX の形式から抽出
                                        const explicit = targetText.match(/1\s*\/\s*([\d,.]+)/);
                                        if (explicit) extractedVal = explicit[1];
                                    }
                                }

                                addLog(`[DATA] ${item.name} (Anchor: "${anchorText}" +${item.offset}行)`);
                                addLog(`       -> Target [Row ${targetRowIdx}]: "${targetText}"`);
                                addLog(`       -> 取得データ: 1/${extractedVal}`);
                            } else {
                                addLog(`[MISS] ${item.name} (Target Row Out of Bounds)`);
                            }
                        } else {
                            addLog(`[MISS] ${item.name} (Anchor "${item.anchor}" Not Found)`);
                        }
                    }

                    addLog("\n>> DEBUG MAPPING COMPLETE.");
                
                } catch(e) { addLog("SYSTEM ERROR: " + e.message); }
            };
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('v_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
        });

        document.getElementById('save-key').onclick = () => { 
            const val = document.getElementById('api-key').value.trim();
            localStorage.setItem('v_key', val); 
            document.getElementById('api-key').value = val;
            alert('API KEY SAVED!'); 
        };

        const fileInput = document.getElementById('file-input');
        fileInput.onclick = (e) => { e.target.value = null; };
        fileInput.onchange = (e) => { if(e.target.files[0]) analyze(e.target.files[0]); };
    </script>
</body>
</html>