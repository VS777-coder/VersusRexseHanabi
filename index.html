<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã·ã‚Šã‚“ã®è§£æ Rev 1.0.38</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&family=Share+Tech+Mono&display=swap');
        body { background-color: #0d0f14; color: #ffffff; font-family: 'Inter', sans-serif; height: 100dvh; width: 100vw; padding: 12px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .kawaii-title { font-family: 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(45deg, #ff7eb3, #ff758c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255,126,179,0.3)); }
        .main-btn { background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); border-radius: 20px; box-shadow: 0 10px 20px rgba(255,0,128,0.4); border: 2px solid #ffffff; transition: transform 0.1s; text-shadow: 0 2px 4px rgba(0,0,0,0.3); line-height: 1.2; }
        .main-btn:active { transform: scale(0.95); }
        .result-card { background-color: #161b22; border-radius: 16px; padding: 14px; border: 1px solid #30363d; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin-bottom: 8px; }
        .bar-bg { background-color: #0d1117; height: 12px; border-radius: 6px; overflow: hidden; margin-top: 4px; border: 1px solid #21262d; }
        .bar-fill { height: 100%; width: 0%; transition: width 1.2s cubic-bezier(0.19, 1, 0.22, 1); }
        .future-log { background-color: #000000; border: 1px solid #ff758c; border-radius: 8px; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 10px; color: #fbcfe8; height: 320px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 8px; box-shadow: inset 0 0 10px rgba(255,117,140,0.1); }
        .api-input { background-color: #161b22; color: #ffffff; border-radius: 99px; padding: 8px 16px; font-size: 12px; width: 100%; border: 1px solid #30363d; outline: none; }
    </style>
</head>
<body>
    <div class="text-center shrink-0 mb-4">
        <div class="text-xl font-black kawaii-title tracking-tighter">âœ¨ VERSUS & HANABI âœ¨</div>
        <p class="text-[8px] text-pink-300 font-bold uppercase">ã¿ãŠã¡ã‚ƒã‚“å°‚ç”¨ Rev 1.0.38</p>
    </div>

    <div class="w-full shrink-0 mb-4 max-w-md mx-auto">
        <label for="file-input" class="main-btn w-full py-4 text-white font-black text-2xl flex items-center justify-center cursor-pointer text-center">ãƒ¦ãƒ‹ãƒ¡ãƒ¢è§£æ<br>å®Ÿè¡Œ</label>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <div class="w-full max-w-md mx-auto result-card">
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-cyan-400"><span>è¨­å®š1</span><span id="p1">---</span></div><div class="bar-bg"><div id="b1" class="bar-fill bg-cyan-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-yellow-400"><span>è¨­å®š2</span><span id="p2">---</span></div><div class="bar-bg"><div id="b2" class="bar-fill bg-yellow-400"></div></div></div>
        <div class="mb-4"><div class="flex justify-between text-xs font-bold text-green-400"><span>è¨­å®š5</span><span id="p5">---</span></div><div class="bar-bg"><div id="b5" class="bar-fill bg-green-400"></div></div></div>
        <div><div class="flex justify-between text-xs font-bold text-red-500"><span>è¨­å®š6</span><span id="p6">---</span></div><div class="bar-bg"><div id="b6" class="bar-fill bg-red-500"></div></div></div>
    </div>

    <div id="log" class="future-log w-full max-w-md mx-auto">READY...</div>

    <div class="w-full max-w-md mx-auto shrink-0 pb-2 flex gap-2">
        <input type="password" id="api-key" class="api-input flex-grow" placeholder="API KEY (VISION API)">
        <button id="save-key" class="bg-slate-700 text-white font-bold py-2 px-6 rounded-full text-[10px]">SAVE</button>
    </div>

    <script>
        // --- (1) æ©Ÿç¨®å®šç¾©ãƒ‡ãƒ¼ã‚¿ (weight 1.0 çµ±ä¸€) ---
        const HANABI_CONFIG = [
            { index: 0, id: "total_bonus", name: "ãƒœãƒ¼ãƒŠã‚¹åˆç®—", active: false, weight: 0.0, probs: {1: 156.0, 2: 148.3, 5: 139.4, 6: 131.6}, keyword: "ãƒœãƒ¼ãƒŠã‚¹" },
            { index: 1, id: "bb", name: "ãƒ“ãƒƒã‚¯ãƒœãƒ¼ãƒŠã‚¹", active: true, weight: 1.0, probs: {1: 277.7, 2: 268.6, 5: 256.0, 6: 248.2}, keyword: "BB" },
            { index: 4, id: "rb", name: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒœãƒ¼ãƒŠã‚¹", active: true, weight: 1.0, probs: {1: 356.2, 2: 331.0, 5: 306.2, 6: 280.1}, keyword: "RB" },
            { index: 6, id: "ba", name: "é¢¨éˆ´ï¼¡", active: true, weight: 1.0, probs: {1: 15.6, 2: 15.3, 5: 15.1, 6: 14.9}, keyword: "é¢¨éˆ´A" },
            { index: 7, id: "bb_b", name: "é¢¨éˆ´ï¼¢", active: true, weight: 1.0, probs: {1: 15.3, 2: 14.9, 5: 14.7, 6: 13.8}, keyword: "é¢¨éˆ´B" },
            { index: 9, id: "ice", name: "æ°·ï¼¡", active: true, weight: 1.0, probs: {1: 54.6, 2: 59.6, 5: 51.2, 6: 54.6}, keyword: "æ°·A" },
            { index: 13, id: "ca2", name: "ãƒã‚§ãƒªãƒ¼ï¼¡ï¼’", active: true, weight: 1.0, probs: {1: 21.0, 2: 19.3, 5: 20.6, 6: 19.9}, keyword: "ãƒã‚§ãƒªãƒ¼A2" },
            { index: 14, id: "cb", name: "ãƒã‚§ãƒªãƒ¼ï¼¢ï¼‘", active: true, weight: 1.0, probs: {1: 282.5, 2: 281.3, 5: 276.5, 6: 274.2}, keyword: "ãƒã‚§ãƒªãƒ¼B1" },
            { index: 15, id: "vc", name: "ãƒãƒŠãƒ“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸­ã¯ãšã‚Œ", active: true, weight: 1.0, probs: {1: 6.6, 2: 6.2, 5: 5.8, 6: 5.3}, keyword: "ãƒãƒ£ãƒ¬ãƒ³ã‚¸" },
            { index: 16, id: "vg", name: "ãƒãƒŠãƒ“ã‚²ãƒ¼ãƒ ä¸­ã¯ãšã‚Œ", active: true, weight: 1.0, probs: {1: 11.7, 2: 10.8, 5: 10.0, 6: 9.4}, keyword: "ã‚²ãƒ¼ãƒ " },
            { index: 18, id: "nf", name: "æ–œã‚é¢¨éˆ´", active: true, weight: 1.0, probs: {1: 11.0, 2: 9.0, 5: 11.0, 6: 9.0}, keyword: "æ–œã‚" }
        ];

        const VERSUS_CONFIG = [
            { index: 1, id: "bb", name: "ãƒ“ãƒƒã‚¯ãƒœãƒ¼ãƒŠã‚¹åˆç®—", active: true, weight: 1.0, probs: {1: 292.6, 2: 284.9, 5: 275.4, 6: 264.3}, keyword: "BB" },
            { index: 4, id: "rb", name: "ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒœãƒ¼ãƒŠã‚¹", active: true, weight: 1.0, probs: {1: 374.5, 2: 341.3, 5: 319.7, 6: 292.6}, keyword: "RB" },
            { index: 6, id: "bell_a", name: "ãƒ™ãƒ«ï¼¡", active: true, weight: 1.0, probs: {1: 10.9, 2: 10.7, 5: 10.5, 6: 10.2}, keyword: "ãƒ™ãƒ«A" },
            { index: 7, id: "bell_b", name: "ãƒ™ãƒ«ï¼¢", active: true, weight: 1.0, probs: {1: 20.9, 2: 21.2, 5: 20.3, 6: 20.6}, keyword: "ãƒ™ãƒ«B" },
            { index: 9, id: "suika_a", name: "ã‚¹ã‚¤ã‚«ï¼¡", active: true, weight: 1.0, probs: {1: 74.5, 2: 70.6, 5: 72.5, 6: 68.8}, keyword: "ã‚¹ã‚¤ã‚«A" },
            { index: 10, id: "suika_b", name: "ã‚¹ã‚¤ã‚«ï¼¢", active: true, weight: 1.0, probs: {1: 218.5, 2: 219.2, 5: 217.9, 6: 218.1}, keyword: "ã‚¹ã‚¤ã‚«B" },
            { index: 13, id: "cherry_b", name: "ãƒã‚§ãƒªãƒ¼ï¼¢", active: true, weight: 1.0, probs: {1: 56.2, 2: 57.7, 5: 53.1, 6: 54.4}, keyword: "ãƒã‚§ãƒªãƒ¼B" },
            { index: 14, id: "vc_miss", name: "ãƒãƒ¼ã‚µã‚¹ãƒãƒ£ãƒ³ã‚¹ã¯ãšã‚Œ", active: true, weight: 1.0, probs: {1: 5.0, 2: 4.9, 5: 4.6, 6: 4.5}, keyword: "ãƒãƒ£ãƒ³ã‚¹" },
            { index: 15, id: "vg_miss", name: "ãƒãƒ¼ã‚µã‚¹ã‚²ãƒ¼ãƒ ã¯ãšã‚Œ", active: true, weight: 1.0, probs: {1: 10.1, 2: 9.4, 5: 8.7, 6: 8.1}, keyword: "ã‚²ãƒ¼ãƒ " },
            { index: 17, id: "cb_hit", name: "ãƒã‚§ãƒªãƒ¼ï¼‹ãƒ™ãƒ«æƒã„", active: true, weight: 1.0, probs: {1: 11.1, 2: 8.9, 5: 11.1, 6: 8.9}, keyword: "æƒã„" },
            { index: 18, id: "cb_miss", name: "ãƒã‚§ãƒªãƒ¼ï¼‹ãƒ™ãƒ«ã¯ãšã‚Œ", active: true, weight: 1.0, probs: {1: 256.0, 2: 128.0, 5: 256.0, 6: 128.0}, keyword: "ã¯ãšã‚Œ" }
        ];

        // --- (2) è§£æãƒ­ã‚¸ãƒƒã‚¯ ---
        const sleep = ms => new Promise(res => setTimeout(res, ms));
        async function addLog(msg, delay = 0, isHtml = false) {
            const l = document.getElementById('log');
            if (isHtml) { l.innerHTML += `\n${msg}`; } else { l.innerText += `\n${msg}`; }
            l.scrollTop = l.scrollHeight;
            if (delay > 0) await sleep(delay);
        }

        async function analyze(file) {
            const key = document.getElementById('api-key').value.trim();
            if (!key) return alert('API KEY missing');
            document.getElementById('log').innerText = "READY...";
            await addLog(">> ANALYSIS STARTING...", 200);

            const reader = new FileReader(); 
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, {
                    method: 'POST', body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] })
                });
                const json = await res.json();
                const raw = json.responses[0]?.textAnnotations;
                if(!raw) return addLog("OCR error.");

                const rawWords = raw.slice(1);
                let rows = [];
                rawWords.forEach(w => {
                    let y = w.boundingPoly.vertices[0].y;
                    let f = rows.find(r => Math.abs(r.y - y) < 10);
                    if (f) { f.words.push(w); } else { rows.push({ y, words: [w] }); }
                });

                const sortedLines = rows.sort((a,b)=>a.y-b.y).map(r => {
                    return r.words.sort((a,b)=>a.boundingPoly.vertices[0].x - b.boundingPoly.vertices[0].x).map(w=>w.description).join(" ");
                });

                // æ©Ÿç¨®ç‰¹å®š (å³æ ¼åŒ–)
                let currentConfig = null;
                const fullText = sortedLines.join("");
                if (fullText.match(/ãƒãƒŠãƒ“|ãƒ‰ãƒ³|èŠ±ç«/)) { currentConfig = HANABI_CONFIG; await addLog(">> MODE: HANABI ğŸ†"); }
                else if (fullText.match(/ãƒãƒ¼ã‚µã‚¹|ï¼¶ï¼¥ï¼²ï¼³ï¼µï¼³/)) { currentConfig = VERSUS_CONFIG; await addLog(">> MODE: VERSUS âš¡"); }
                
                if (!currentConfig) return await addLog("âŒ ERROR: æ©Ÿç¨®ç‰¹å®šä¸èƒ½ã€‚åœæ­¢ã—ã¾ã™ã€‚");

                // ç·ãƒ—ãƒ¬ã‚¤æ•°æ¤œå‡º (æœ€åˆã®10è¡Œä»¥å†…ã®G/ï¼§æ¤œç´¢)
                let totalG = 0; let startParsing = false; let startIndex = 0;
                for (let i = 0; i < Math.min(sortedLines.length, 10); i++) {
                    const line = sortedLines[i].replace(/\s/g, '');
                    if (line.includes("ç·ãƒ—ãƒ¬ã‚¤æ•°") && line.match(/[Gï¼§]/)) {
                        let gMatch = line.match(/([\d,]+)/);
                        if (gMatch) {
                            totalG = parseInt(gMatch[1].replace(/,/g, ''));
                            startParsing = true; startIndex = i;
                            await addLog(`[START] TotalG: ${totalG}G ğŸ†—`);
                            break;
                        }
                    }
                }
                if (!startParsing) return await addLog("âŒ ERROR: ç·ãƒ—ãƒ¬ã‚¤æ•°(G)æœªæ¤œå‡ºã€‚");

                await addLog("\n--- (3) DATA MAPPING ---", 200);
                let configPtr = 0; let extractedData = [];
                for (let i = startIndex + 1; i < sortedLines.length; i++) {
                    const line = sortedLines[i];
                    if (!line.includes("/")) continue;

                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è£œåŠ©ãƒãƒƒãƒãƒ³ã‚° (è¡Œå†…ã®æ–‡å­—ã§Indexã‚’ç‰¹å®š)
                    let foundIdx = -1;
                    for (let j = 0; j < currentConfig.length; j++) {
                        if (line.includes(currentConfig[j].keyword)) {
                            foundIdx = j; break;
                        }
                    }

                    // é †ç•ªãƒ™ãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¤ã¤ã€è¦‹ã¤ã‹ã‚Œã°è£œæ­£
                    let targetIdx = (foundIdx !== -1) ? foundIdx : configPtr;
                    if (targetIdx >= currentConfig.length) continue;

                    const item = currentConfig[targetIdx];
                    let probMatch = line.match(/1\s*\/\s*([\d,.]+)/);
                    if (!probMatch) continue;

                    let pVal = parseFloat(probMatch[1].replace(/,/g, ''));
                    let cVal = 0;
                    // å›æ•°(pos:-1ã€œ-3)ã‚’æ¢ç´¢
                    for (let offset = 1; offset <= 3; offset++) {
                        const targetIdxLine = i - offset;
                        if (targetIdxLine >= 0 && sortedLines[targetIdxLine].includes("å›")) {
                            let cMatch = sortedLines[targetIdxLine].match(/([\d,]+)/);
                            if (cMatch) { cVal = parseInt(cMatch[1].replace(/,/g, '')); break; }
                        }
                    }

                    const matchType = (foundIdx !== -1) ? `[MATCH: ${item.name}]` : `[AUTO: ${item.name}]`;
                    const logMsg = `> ${matchType} ${cVal}å› | 1/${pVal}`;
                    
                    if (item.active) { await addLog(`<span class="text-green-400">${logMsg}</span>`, 10, true); }
                    else { await addLog(logMsg, 10); }

                    extractedData.push({ item, k: cVal, p_ocr: pVal });
                    configPtr = targetIdx + 1;
                }

                await addLog("\n--- (4) LIKELIHOOD CALC ---", 200);
                const rtIds = ['vc', 'vg', 'nf', 'vc_miss', 'vg_miss', 'cb_hit', 'cb_miss'];
                let logLikelihoods = { 1:0, 2:0, 5:0, 6:0 };
                
                for (const d of extractedData) {
                    if (d.item.active && totalG > 0) {
                        let n = rtIds.includes(d.item.id) ? Math.round(d.k * d.p_ocr) : totalG;
                        let lineLog = `[L-CALC] ${d.item.name.padEnd(8,' ')} | n=${String(n).padEnd(5,' ')} `;
                        
                        [1,2,5,6].forEach(s => {
                            let p = 1 / d.item.probs[s];
                            let L = (d.k * Math.log(p) + (n - d.k) * Math.log(1 - p)) * d.item.weight;
                            logLikelihoods[s] += L;
                            lineLog += `S${s}:${L.toFixed(1)} `;
                        });
                        await addLog(`<span class="text-green-400">${lineLog}</span>`, 30, true);
                    }
                }

                await addLog("\n--- (5) FINAL RESULT ---", 200);
                const max = Math.max(...Object.values(logLikelihoods));
                const exps = Object.fromEntries(Object.entries(logLikelihoods).map(([s, l]) => [s, Math.exp(l - max)]));
                const sum = Object.values(exps).reduce((a,b)=>a+b, 0);
                
                [1,2,5,6].forEach(s => {
                    let pct = ((exps[s] / sum) * 100).toFixed(1);
                    document.getElementById(`p${s}`).innerText = `${pct}%`;
                    document.getElementById(`b${s}`).style.width = `${pct}%`;
                });
                await addLog("ANALYSIS COMPLETE.");
            };
        }

        if(localStorage.getItem('v_key')) document.getElementById('api-key').value = localStorage.getItem('v_key');
        document.getElementById('save-key').onclick = () => { localStorage.setItem('v_key', document.getElementById('api-key').value); alert('SAVE OK'); };
        document.getElementById('file-input').onchange = (e) => analyze(e.target.files[0]);
    </script>
</body>
</html>