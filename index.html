<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ユニメモ解析ツール Rev 1.2.0</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 200px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ユニメモ解析ツール (Rev 1.2.0)</h2>
    <p>OCRで読み取ったテキストを貼り付けてください。</p>
    <textarea id="ocrInput" placeholder="ここにテキストを貼り付け..."></textarea>
    <button onclick="analyze()">解析実行</button>
    <div id="result"></div>
</div>

<script>
/**
 * 憲法：常駐項目のみを対象とし、指定された名称でログを出力する
 */
const MASTER_CONFIG = {
    VERSUS: {
        name: "バーサスリヴァイズ",
        items: [
            { id: "total_g", name: "総プレイ数", key: "総プレイ数", type: "count" },
            { id: "bb", name: "ビックボーナス", key: "#BB", type: "ratio" },
            { id: "rb", name: "レギュラーボーナス", key: "RB", type: "ratio" },
            { id: "bell_a", name: "ベルA", key: "ベル A", type: "ratio" },
            { id: "bell_b", name: "ベルB", key: "ベル B", type: "ratio" },
            { id: "suika_a", name: "スイカA", key: "スイカ A", type: "ratio" },
            { id: "cherry_b", name: "チェリーB", key: "チェリー B", type: "ratio" },
            { id: "vc_h", name: "バーサスチャンスはずれ", key: "VSチャンス中はずれ", type: "ratio", anchor: "RT詳細" },
            { id: "vg_h", name: "バーサスゲームはずれ", key: "VSGAME中はずれ", type: "ratio", anchor: "RT詳細" },
            { id: "cb_s", name: "チェリー＋ベル揃い", key: "チェリー+ベル揃い", type: "ratio", anchor: "BB中詳細" },
            { id: "cb_h", name: "チェリー＋ベルはずれ", key: "チェリー+ベルはずれ", type: "ratio", anchor: "BB中詳細" }
        ]
    },
    HANABI: {
        name: "新ハナビ",
        items: [
            { id: "total_g", name: "総プレイ数", key: "総プレイ数", type: "count" },
            { id: "bb", name: "ビックボーナス", key: "BB", type: "ratio" },
            { id: "rb", name: "レギュラーボーナス", key: "RB", type: "ratio" },
            { id: "bell_a", name: "風鈴A", key: "風鈴 A", type: "ratio" },
            { id: "bell_b", name: "風鈴B", key: "風鈴 B", type: "ratio" },
            { id: "ice_a", name: "氷A", key: "氷 A", type: "ratio" },
            { id: "cherry_a2", name: "チェリーA2", key: "チェリー A2", type: "ratio" },
            { id: "cherry_b", name: "チェリーB", key: "チェリー B", type: "ratio" },
            { id: "hc_h", name: "ハナビチャンスはずれ", key: "HC中はずれ", type: "ratio", anchor: "RT詳細" },
            { id: "hg_h", name: "ハナビゲームはずれ", key: "HG中はずれ", type: "ratio", anchor: "RT詳細" },
            { id: "slope_f", name: "斜め風鈴", key: "斜め風鈴", type: "ratio", anchor: "BB中詳細" }
        ]
    }
};

function analyze() {
    let rawText = document.getElementById('ocrInput').value;
    if (!rawText) return;

    // 1. カンマを抹殺
    const text = rawText.replace(/,/g, '');

    // 2. 機種判定
    const machine = text.includes("バーサス") ? "VERSUS" : (text.includes("ハナビ") ? "HANABI" : null);
    if (!machine) {
        document.getElementById('result').innerHTML = '<p class="error">機種が判定できません（バーサス/ハナビの文字が必要）</p>';
        return;
    }

    const config = MASTER_CONFIG[machine];
    
    // 3. セクション分割 (アンカーによる隔離)
    const sections = splitSections(text);

    let html = `<h3>${config.name} 解析結果</h3><table><tr><th>項目</th><th>回数</th><th>確率分母</th></tr>`;

    config.items.forEach(item => {
        const targetText = item.anchor ? (sections[item.anchor] || "") : text;
        const result = extractValue(targetText, item.key, item.type);
        
        html += `<tr>
            <td>${item.name}</td>
            <td>${result.count ? result.count.toLocaleString() + (item.id === "total_g" ? " G" : " 回") : "---"}</td>
            <td>${result.ratio ? "1 / " + result.ratio : "---"}</td>
        </tr>`;
    });

    html += `</table>`;
    document.getElementById('result').innerHTML = html;
}

function splitSections(text) {
    const anchors = ["RT詳細", "BB中詳細", "RB中詳細", "連チャンBGM", "その他"];
    let sections = {};
    let lastIndex = 0;
    
    for (let i = 0; i < anchors.length; i++) {
        let currentIndex = text.indexOf(anchors[i]);
        if (currentIndex !== -1) {
            if (i > 0) sections[anchors[i-1]] = text.substring(lastIndex, currentIndex);
            lastIndex = currentIndex;
        }
    }
    sections[anchors[anchors.length-1]] = text.substring(lastIndex);
    return sections;
}

function extractValue(text, key, type) {
    // キーワード直後の数値を抽出。確率分母は 1/XXX.X 形式を狙う
    const keyEscaped = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    const regex = new RegExp(keyEscaped + "[\\s\\S]{0,50}?(\\d+)\\s*回?\\s*(?:1/(\\d+\\.?\\d*))?");
    const match = text.match(regex);

    if (match) {
        return {
            count: parseInt(match[1]),
            ratio: match[2] ? parseFloat(match[2]) : null
        };
    }
    
    // 総プレイ数用の特別パターン
    if (key === "総プレイ数") {
        const gMatch = text.match(/総プレイ数\s*(\d+)G/);
        if (gMatch) return { count: parseInt(gMatch[1]), ratio: null };
    }

    return { count: null, ratio: null };
}
</script>

</body>
</html>