<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>みおの生データ確認 1.1.13-Raw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d0f14; color: #ffffff; font-family: monospace; padding: 12px; }
        .main-btn { background: #334155; border: 2px solid #fff; border-radius: 8px; width: 100%; py: 16px; font-weight: bold; }
        .raw-log { background-color: #000; border: 1px solid #00ffcc; border-radius: 8px; padding: 12px; font-size: 12px; color: #00ffcc; white-space: pre-wrap; height: 80vh; overflow-y: auto; margin-top: 12px; }
    </style>
</head>
<body>
    <label for="file-input" class="main-btn flex items-center justify-center p-4 cursor-pointer">
        画像をアップロードして生テキストを確認
    </label>
    <input type="file" id="file-input" class="hidden" accept="image/*">
    <input type="password" id="api-key" class="mt-2 w-full p-2 bg-gray-800 text-white text-xs" placeholder="API KEY">

    <div id="log" class="raw-log">ここにOCRの生データが表示されます。</div>

    <script>
        if(localStorage.getItem('v_key')) document.getElementById('api-key').value = localStorage.getItem('v_key');
        
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            localStorage.setItem('v_key', document.getElementById('api-key').value);
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                document.getElementById('log').innerText = "OCR解析中...";
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${document.getElementById('api-key').value}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const json = await res.json();
                const ann = json.responses[0]?.textAnnotations;
                
                if (ann) {
                    const items = ann.slice(1).map(a => ({
                        text: a.description,
                        x: (a.boundingPoly.vertices[0].x + a.boundingPoly.vertices[2].x) / 2,
                        y: (a.boundingPoly.vertices[0].y + a.boundingPoly.vertices[2].y) / 2
                    }));

                    // 動的しきい値の計算
                    const maxY = Math.max(...items.map(it => it.y));
                    const minY = Math.min(...items.map(it => it.y));
                    const threshold = (maxY - minY) * 0.015;

                    // 座標ソート
                    items.sort((a, b) => a.y - b.y);
                    let rows = [], cur = [items[0]];
                    for (let i = 1; i < items.length; i++) {
                        if (Math.abs(items[i].y - cur[0].y) < threshold) cur.push(items[i]);
                        else { rows.push(cur); cur = [items[i]]; }
                    }
                    rows.push(cur);

                    // 1行ずつ結合して出力
                    const rawText = rows.map(r => r.sort((a, b) => a.x - b.x).map(it => it.text).join(' ')).join('\n');
                    
                    document.getElementById('log').innerHTML = 
                        `【画像サイズ（Y軸範囲）】: ${maxY - minY}px\n` +
                        `【計算された行判定閾値】: ${threshold.toFixed(2)}px\n` +
                        `------------------------------------------\n` +
                        rawText;
                } else {
                    document.getElementById('log').innerText = "文字が検出できませんでした。";
                }
            };
        };
    </script>
</body>
</html>