<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L-HANABI / VERSUS / SMART-HANABI Rev 1.3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Squada+One&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #0b0d11; color: #ffffff; font-family: 'Inter', sans-serif; height: 100dvh; width: 100%; margin: 0; padding: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .kawaii-title { font-family: 'Squada One', cursive; background: linear-gradient(180deg, #00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2rem; line-height: 1.0; text-align: center;}
        .ver-text { font-size: 10px; color: #06b6d4; font-weight: bold; text-align: center; margin-bottom: 8px;}
        .main-btn { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); border-radius: 12px; border: 2px solid #3b82f6; cursor: pointer; height: 75px; display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 12px; }
        .main-btn span { letter-spacing: 2px; font-weight: 900; font-size: 1.3rem; text-align: center; color: #fff; }
        .result-card { background-color: #0f172a; border-radius: 12px; padding: 10px; border: 1px solid #1e293b; margin-bottom: 8px; }
        .bar-bg { background-color: #020617; height: 10px; border-radius: 4px; overflow: hidden; margin-top: 2px; border: 1px solid #1e293b; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; }
        .future-log { background-color: #000; border: 1px solid #00d2ff; border-radius: 8px; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 10px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; }
        .api-footer { display: flex; gap: 8px; margin-top: 8px; }
        .api-input { background: #0f172a; color: #fff; border: 1px solid #1e293b; border-radius: 6px; padding: 8px; font-size: 12px; flex-grow: 1; }
        .save-btn { background: #1e293b; color: #00d2ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 0 12px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="kawaii-title uppercase">TOTAL ANALYSIS</div>
    <div class="ver-text">Rev 1.3.0 (Versus & Smart-Hanabi Ready)</div>

    <label for="file-input" class="main-btn"><span>Ë§áÊï∞ÁîªÂÉè„ÇíÈÅ∏Êäû„ÉªËß£Êûê</span></label>
    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>

    <div id="result-area" class="result-card">
        <div class="mb-2"><div class="flex justify-between text-[11px] font-bold text-cyan-400"><span>Ë®≠ÂÆö1</span><span id="p1">---</span></div><div class="bar-bg"><div id="b1" class="bar-fill bg-cyan-400"></div></div></div>
        <div class="mb-2"><div class="flex justify-between text-[11px] font-bold text-yellow-400"><span>Ë®≠ÂÆö2</span><span id="p2">---</span></div><div class="bar-bg"><div id="b2" class="bar-fill bg-yellow-400"></div></div></div>
        <div class="mb-2"><div class="flex justify-between text-[11px] font-bold text-green-400"><span>Ë®≠ÂÆö5</span><span id="p5">---</span></div><div class="bar-bg"><div id="b5" class="bar-fill bg-green-400"></div></div></div>
        <div><div class="flex justify-between text-[11px] font-bold text-red-400"><span>Ë®≠ÂÆö6</span><span id="p6">---</span></div><div class="bar-bg"><div id="b6" class="bar-fill bg-red-400"></div></div></div>
    </div>

    <div id="log" class="future-log"></div>

    <div class="api-footer">
        <input type="password" id="api-key" class="api-input" placeholder="VISION API KEY">
        <button id="save-key" class="save-btn">SAVE</button>
    </div>

    <script>
        // --- „ÄêËÅñÂüü„ÄëÂÖ®Ê©üÁ®ÆÁµ±ÂêàÂÆöÁæ©Ë°® ---
        const MASTER_CONFIG = [
            { id: "total", name: "„Éú„Éº„Éä„ÇπÂêàÁÆó", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "bb", name: "„Éì„ÉÉ„ÇØ„Éú„Éº„Éä„Çπ", active: true, probs: {1: 297.9, 2: 292.6, 5: 284.9, 6: 273.1} },
            { id: "don", name: "„Éâ„É≥BB", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "red7", name: "Ëµ§‰∏ÉBB", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "rb", name: "„É¨„ÇÆ„É•„É©„Éº„Éú„Éº„Éä„Çπ", active: true, probs: {1: 394.8, 2: 358.1, 5: 313.6, 6: 282.5} },
            { id: "ba", name: "È¢®Èà¥Ôº°", active: true, probs: {1: 12.9, 2: 12.5, 5: 12.1, 6: 11.5} },
            { id: "bb_b", name: "È¢®Èà¥Ôº¢", active: true, probs: {1: 38.4, 2: 38.7, 5: 36.2, 6: 34.5} },
            { id: "ia", name: "Ê∞∑Ôº°", active: true, probs: {1: 46.3, 2: 47.3, 5: 46.2, 6: 47.4} },
            { id: "ca2", name: "„ÉÅ„Çß„É™„ÉºÔº°Ôºí", active: true, probs: {1: 21.0, 2: 19.4, 5: 20.5, 6: 19.6} },
            { id: "cb", name: "„ÉÅ„Çß„É™„ÉºÔº¢", active: true, probs: {1: 307.7, 2: 306.2, 5: 300.6, 6: 297.9} },
            { id: "vc", name: "„Éè„Éä„Éì„ÉÅ„É£„É¨„É≥„Ç∏‰∏≠„Éè„Ç∫„É¨", active: true, probs: {1: 4.7, 2: 4.5, 5: 4.3, 6: 4.2} },
            { id: "vg", name: "„Éè„Éä„Éì„Ç≤„Éº„É†‰∏≠„Éè„Ç∫„É¨", active: true, probs: {1: 6.4, 2: 6.0, 5: 5.4, 6: 5.4} },
            // VERSUS / SMART HANABI Êã°Âºµ
            { id: "v_bel_m", name: "‰∏≠ÊÆµÈ¢®Èà¥", active: true, probs: {1: 100, 2: 90, 5: 80, 6: 70} }, // ‰æãÊï∞ÂÄ§
            { id: "v_bel_s", name: "Êñú„ÇÅÈ¢®Èà¥", active: true, probs: {1: 10.5, 2: 10.2, 5: 9.8, 6: 9.4} },
            { id: "one_target", name: "1ÊûöÂΩπ", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "rt_ratio", name: "RTÊØîÁéáÂà§Âà•", active: false, probs: {1:1,2:1,5:1,6:1} }
        ];

        const clean = s => s.replace(/[ÔºÅ-ÔΩû]/g, r => String.fromCharCode(r.charCodeAt(0) - 0xFEE0)).replace(/\s+/g, '');

        async function addLog(msg, color = "text-cyan-400") {
            const l = document.getElementById('log');
            const d = document.createElement('div'); d.className = color; d.innerHTML = msg;
            l.appendChild(d); l.scrollTop = l.scrollHeight;
        }

        function getTargetIdx(nameRaw) {
            const n = clean(nameRaw);
            const map = {
                "bb": ["Á∑èBB", "„Éì„ÉÉ„ÇØ„Éú„Éº„Éä„Çπ"],
                "don": ["„Éâ„É≥BB"],
                "red7": ["Ëµ§‰∏ÉBB"],
                "rb": ["„É¨„ÇÆ„É•„É©„Éº„Éú„Éº„Éä„Çπ", "RB"],
                "ba": ["È¢®Èà¥A", "È¢®Èà¥Ôº°"],
                "bb_b": ["È¢®Èà¥B", "È¢®Èà¥Ôº¢"],
                "ia": ["Ê∞∑A", "Ê∞∑Ôº°"],
                "ca2": ["„ÉÅ„Çß„É™„ÉºA2", "„ÉÅ„Çß„É™„ÉºÔº°Ôºí"],
                "cb": ["„ÉÅ„Çß„É™„ÉºB", "„ÉÅ„Çß„É™„ÉºÔº¢"],
                "vc": ["„Éè„Éä„Éì„ÉÅ„É£„É¨„É≥„Ç∏‰∏≠„Éè„Ç∫„É¨", "„Éè„Éä„Éì„ÉÅ„É£„É¨„É≥„Ç∏‰∏≠„ÅØ„Åö„Çå", "HC‰∏≠„Éè„Ç∫„É¨"],
                "vg": ["„Éè„Éä„Éì„Ç≤„Éº„É†‰∏≠„Éè„Ç∫„É¨", "„Éè„Éä„Éì„Ç≤„Éº„É†‰∏≠„ÅØ„Åö„Çå", "HG‰∏≠„Éè„Ç∫„É¨"],
                "v_bel_m": ["‰∏≠ÊÆµÈ¢®Èà¥", "‰∏≠ÊÆµÈ¢®Èà¥ÊèÉ„ÅÑ"],
                "v_bel_s": ["Êñú„ÇÅÈ¢®Èà¥", "Êñú„ÇÅÈ¢®Èà¥ÊèÉ„ÅÑ"],
                "one_target": ["1ÊûöÂΩπ", "1ÊûöÂΩπÂêàÁÆó"]
            };
            for (let [id, keywords] of Object.entries(map)) {
                if (keywords.some(k => n === clean(k))) return MASTER_CONFIG.findIndex(c => c.id === id);
            }
            return -1;
        }

        async function processMulti(files) {
            const key = document.getElementById('api-key').value.trim();
            if (!key) { alert("API KEY"); return; }
            document.getElementById('log').innerHTML = "ANALYZING...";

            try {
                let allTexts = [];
                for (let f of files) {
                    const b64 = await new Promise(res => { const r = new FileReader(); r.onload = e => res(e.target.result.split(',')[1]); r.readAsDataURL(f); });
                    const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${key}`, { method: 'POST', body: JSON.stringify({ requests: [{ image: { content: b64 }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }) });
                    const j = await res.json();
                    const lines = j.responses[0].textAnnotations.slice(1).reduce((acc, w) => {
                        let y = Math.round(w.boundingPoly.vertices[0].y / 12) * 12;
                        let r = acc.find(row => row.y === y);
                        if (r) r.txt.push(w.description); else acc.push({y, txt: [w.description]});
                        return acc;
                    }, []).sort((a,b)=>a.y-b.y).map(r => r.txt.join(" "));
                    allTexts.push(lines);
                }

                const pIdx = allTexts.findIndex(lines => lines.some(l => l.includes('G')));
                if (pIdx === -1) throw new Error("Á∑èGÊï∞‰∏çÊòé");
                const totalG = parseInt(allTexts[pIdx].find(l => l.includes('G')).match(/(\d+)/)[1]);
                
                let masterData = MASTER_CONFIG.map(() => ({ k: 0, pStr: "" }));

                await addLog(`[1. MERGE LOG]`, "text-yellow-400 font-bold");
                allTexts.forEach((lines, imgIdx) => {
                    lines.forEach((l, i) => {
                        const m = l.match(/1?\s*\/\s*([\d.]+)/);
                        if (m && i >= 2) {
                            const name = lines[i-1];
                            const count = parseInt(lines[i-2].replace(/,/g,''));
                            const idx = getTargetIdx(name);
                            if (idx !== -1) {
                                if (masterData[idx].k === 0) {
                                    masterData[idx] = { k: count, pStr: m[1] };
                                    addLog(`ADOPT: ${MASTER_CONFIG[idx].name} (${count}Âõû) from IMG_${imgIdx}`);
                                } else if (masterData[idx].k !== count) {
                                    addLog(`‚ö†Ô∏è CONFLICT: ${MASTER_CONFIG[idx].name} (${masterData[idx].k} vs ${count})`, "text-red-500");
                                }
                            }
                        }
                    });
                });

                // Â∞§Â∫¶Ë®àÁÆó
                let lls = { 1:0, 2:0, 5:0, 6:0 };
                await addLog(`\n[2. CALC]`, "text-green-400 font-bold");
                MASTER_CONFIG.forEach((c, i) => {
                    const d = masterData[i];
                    if (d.k > 0 && c.active) {
                        [1,2,5,6].forEach(s => {
                            let p = 1/c.probs[s];
                            lls[s] += d.k * Math.log(p) + (totalG - d.k) * Math.log(1-p);
                        });
                        addLog(`üìä ${c.name}: ${d.k}Âõû / ${totalG}G`);
                    }
                });

                // Ë°®Á§∫Êõ¥Êñ∞
                const max = Math.max(...Object.values(lls));
                const sum = Object.values(lls).reduce((a, b) => a + Math.exp(b - max), 0);
                [1,2,5,6].forEach(s => {
                    const prob = (Math.exp(lls[s]-max) / sum) * 100;
                    document.getElementById(`p${s}`).innerText = prob.toFixed(1) + "%";
                    document.getElementById(`b${s}`).style.width = prob + "%";
                });

            } catch (e) { addLog("ERR: " + e.message, "text-red-500"); }
        }

        document.getElementById('file-input').addEventListener('change', e => processMulti(e.target.files));
        document.getElementById('save-key').addEventListener('click', () => { localStorage.setItem('v_key', document.getElementById('api-key').value); alert('SAVED'); });
        window.onload = () => { document.getElementById('api-key').value = localStorage.getItem('v_key') || ""; };
    </script>
</body>
</html>