<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANALYZER Rev 2.2.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Squada+One&display=swap');
        body { background-color: #0c0a09; color: #f3e8d2; font-family: 'Inter', sans-serif; margin: 0; padding: 10px; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .log-panel { background-color: #000000; border: 1px solid #451a03; border-radius: 4px; padding: 10px; font-family: 'Share Tech Mono', monospace; font-size: 10px; flex-grow: 1; overflow-y: auto; color: #d1d5db; border-left: 4px solid #f59e0b; }
        .res-box { background-color: #1c1917; border: 1px solid #78350f; border-radius: 8px; padding: 10px; margin-bottom: 8px; flex-shrink: 0; }
        .bar-bg { background-color: #000; height: 6px; border-radius: 3px; margin-top: 2px; }
        .bar-fill { height: 100%; transition: width 0.8s ease-out; }
        .rescue-text { color: #f87171; font-weight: bold; background-color: #450a0a; }
        .ok-text { color: #4ade80; }
        table { width: 100%; border-collapse: collapse; font-size: 9px; margin: 5px 0; }
        th { text-align: left; color: #f59e0b; border-bottom: 1px solid #451a03; }
        td { padding: 2px; border-bottom: 1px solid #1c1917; }
    </style>
</head>
<body>

    <div class="res-box">
        <div id="machine-disp" class="text-amber-500 font-bold text-sm mb-1">READY...</div>
        <div class="grid grid-cols-4 gap-2" id="bars"></div>
    </div>

    <div class="log-panel" id="log">
        <div class="text-amber-700 font-bold">ANALYZER SYSTEM Rev 2.2.8 : STANDBY</div>
    </div>

    <div class="mt-2 flex gap-2 shrink-0 pb-2">
        <input type="password" id="api-key" class="bg-zinc-900 text-white p-2 text-xs flex-grow rounded border border-amber-900" placeholder="VISION API KEY">
        <label class="bg-amber-700 px-6 py-2 rounded text-xs font-bold cursor-pointer text-white shadow-lg transition-all">解析実行<input type="file" id="file-input" class="hidden" multiple accept="image/*"></label>
    </div>

<script>
// --- （６）規律：あなたが提示した最新定義を「一文字も変えず」に配置 ---
const L_HANABI_CONFIG = [
    { id: "total", name: "ボーナス合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "bb", name: "ビックボーナス", active: true, type: "normal", probs: {1: 297.9, 2: 292.6, 5: 284.9, 6: 273.1} },
    { id: "don", name: "ドンBB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "red7", name: "赤七BB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "rb", name: "レギュラーボーナス", active: true, type: "normal", probs: {1: 394.8, 2: 358.1, 5: 313.6, 6: 282.5} },
    { id: "ba", name: "風鈴Ａ", active: true, type: "normal", probs: {1: 12.9, 2: 12.5, 5: 12.1, 6: 11.5} },
    { id: "bb_b", name: "風鈴Ｂ", active: true, type: "normal", probs: {1: 38.4, 2: 38.7, 5: 36.2, 6: 34.5} },
    { id: "f_tot", name: "風鈴合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ia", name: "氷Ａ", active: true, type: "normal", probs: {1: 46.3, 2: 47.3, 5: 46.2, 6: 47.4} },
    { id: "ib", name: "氷Ｂ", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "i_tot", name: "氷合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ca1", name: "チェリーＡ１", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ca2", name: "チェリーＡ２", active: true, type: "normal", probs: {1: 21.0, 2: 19.4, 5: 20.5, 6: 19.6} },
    { id: "cb", name: "チェリーＢ", active: true, type: "normal", probs: {1: 307.7, 2: 306.2, 5: 300.6, 6: 297.9} },
    { id: "c_tot", name: "チェリー合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "vc", name: "ハナビチャレンジ中ハズレ", active: true, type: "vc", probs: {1: 4.7, 2: 4.5, 5: 4.3, 6: 4.2} },
    { id: "vg", name: "ハナビゲーム中ハズレ", active: true, type: "vg", probs: {1: 6.4, 2: 6.0, 5: 5.4, 6: 5.4} },
    { id: "b_ba", name: "BIG中風鈴Ａ", active: true, type: "big", probs: {1: 1.1, 2: 1.2, 5: 1.1, 6: 1.2} },
    { id: "b_bb", name: "BIG中風鈴Ｂ", active: true, type: "big", probs: {1: 10.0, 2: 7.0, 5: 10.0, 6: 7.0} }
];

const HANABI_CONFIG = [
    { id: "total", name: "ボーナス合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "bb", name: "ビックボーナス", active: true, type: "normal", probs: {1: 277.7, 2: 268.6, 5: 256.0, 6: 248.2} },
    { id: "don", name: "ドンBB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "red", name: "赤七BB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "rb", name: "レギュラーボーナス", active: true, type: "normal", probs: {1: 356.2, 2: 331.0, 5: 306.2, 6: 280.1} },
    { id: "f_tot", name: "風鈴合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ba", name: "風鈴Ａ", active: true, type: "normal", probs: {1: 15.6, 2: 15.3, 5: 15.1, 6: 14.9} },
    { id: "bb_b", name: "風鈴Ｂ", active: true, type: "normal", probs: {1: 15.3, 2: 14.9, 5: 14.7, 6: 13.8} },
    { id: "i_tot", name: "氷合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ia", name: "氷Ａ", active: true, type: "normal", probs: {1: 54.6, 2: 59.6, 5: 51.2, 6: 54.6} },
    { id: "ib", name: "氷Ｂ", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "c_tot", name: "チェリー合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ca1", name: "チェリーＡ１", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ca2", name: "チェリーＡ２", active: true, type: "normal", probs: {1: 21.0, 2: 19.3, 5: 20.6, 6: 19.9} },
    { id: "cb", name: "チェリーＢ", active: true, type: "normal", probs: {1: 282.5, 2: 281.3, 5: 276.5, 6: 274.2} },
    { id: "vc", name: "ハナビチャレンジ中ハズレ", active: true, type: "vc", probs: {1: 6.6, 2: 6.2, 5: 5.8, 6: 5.3} },
    { id: "vg", name: "ハナビゲーム中ハズレ", active: true, type: "vg", probs: {1: 11.7, 2: 10.8, 5: 10.0, 6: 9.4} },
    { id: "pf", name: "平行風鈴", active: false, type: "big", probs: {1: 1.1, 2: 1.13, 5: 1.1, 6: 1.13} },
    { id: "nf", name: "斜め風鈴", active: true, type: "big", probs: {1: 11.0, 2: 9.0, 5: 11.0, 6: 9.0} }
];

const VERSUS_CONFIG = [
    { id: "total", name: "ボーナス合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "bb", name: "ビックボーナス合算", active: true, type: "normal", probs: {1: 292.6, 2: 284.9, 5: 275.4, 6: 264.3} },
    { id: "xbb", name: "XBB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "7bb", name: "7BB", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "rb", name: "レギュラーボーナス", active: true, type: "normal", probs: {1: 374.5, 2: 341.3, 5: 319.7, 6: 292.6} },
    { id: "f_tot", name: "ベル合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ba", name: "ベルＡ", active: true, type: "normal", probs: {1: 10.9, 2: 10.7, 5: 10.5, 6: 10.2} },
    { id: "bb_b", name: "ベルＢ", active: true, type: "normal", probs: {1: 20.9, 2: 21.2, 5: 20.3, 6: 20.6} },
    { id: "i_tot", name: "スイカ合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "sa", name: "スイカＡ", active: true, type: "normal", probs: {1: 74.5, 2: 70.6, 5: 72.5, 6: 68.8} },
    { id: "sb", name: "スイカＢ", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "che_tot", name: "チェリー合算", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "ca", name: "チェリーＡ", active: false, type: "normal", probs: {1:1,2:1,5:1,6:1} },
    { id: "cb", name: "チェリーＢ", active: true, type: "normal", probs: {1: 56.2, 2: 57.7, 5: 53.1, 6: 54.4} },
    { id: "vc", name: "バーサスチャンス中ハズレ", active: true, type: "vc", probs: {1: 5.0, 2: 4.9, 5: 4.6, 4.5: 4.5} },
    { id: "vg", name: "バーサスゲーム中ハズレ", active: true, type: "vg", probs: {1: 10.1, 2: 9.4, 5: 8.7, 6: 8.1} },
    { id: "rb_bel", name: "ベル揃い", active: false, type: "big", probs: {1: 1.0, 2: 1.0, 5: 1.0, 6: 1.0} },
    { id: "cbs", name: "チェリー＋ベル揃い", active: true, type: "big", probs: {1: 11.1, 2: 8.9, 5: 11.1, 6: 8.9} },
    { id: "cbh", name: "チェリー＋ベルはずれ", active: true, type: "big", probs: {1: 256.0, 2: 128.0, 5: 256.0, 6: 128.0} }
];

const lp = document.getElementById('log');
const wl = (m, c="") => { const e=document.createElement('div'); e.className=c; e.innerHTML=m; lp.appendChild(e); lp.scrollTop=lp.scrollHeight; };
const st = (n, t) => wl(`\n<span class="text-amber-500 font-bold underline">（${n}）${t}</span>`);

async function run(files) {
    const k = document.getElementById('api-key').value;
    if(!k) return alert("KEYを入力");
    lp.innerHTML = "";
    
    try {
        st(1, "画像情報");
        let raws = [];
        for(let f of files) {
            wl(`FILE: ${f.name}`);
            const b = await new Promise(r => { const rd=new FileReader(); rd.onload=e=>r(e.target.result.split(',')[1]); rd.readAsDataURL(f); });
            const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${k}`, {
                method: 'POST', body: JSON.stringify({ requests: [{ image: { content: b }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] })
            });
            const j = await res.json();
            const l = j.responses[0].textAnnotations.slice(1).reduce((acc, w) => {
                let y = w.boundingPoly.vertices[0].y;
                let r = acc.find(row => Math.abs(row.y - y) <= 10);
                if(r) r.words.push({x: w.boundingPoly.vertices[0].x, text: w.description});
                else acc.push({y, words:[{x: w.boundingPoly.vertices[0].x, text: w.description}]});
                return acc;
            }, []).sort((a,b)=>a.y-b.y).map(r=>({text: r.words.sort((a,b)=>a.x-b.x).map(w=>w.text).join(" "), y: r.y}));
            raws.push({name: f.name, lines: l});
        }

        st(2, "画像の順番判定");
        raws.sort((a, b) => b.lines.some(l => l.text.includes("G")) - a.lines.some(l => l.text.includes("G")));
        raws.forEach((r, i) => wl(`P${i}: ${r.name} -> ${i==0?'HEADER':'SUB'}`));

        st(3, "画像別の生データ");
        raws.forEach((r, i) => {
            wl(`IMG[${i}] : ${r.name}`, "text-blue-400");
            r.lines.forEach((l, li) => wl(`<span class="text-zinc-600">#${li.toString().padStart(2,'0')}</span> ${l.text}`));
        });

        st(4, "機種判定");
        let headTxt = raws[0].lines.slice(0, 15).map(l=>l.text).join("");
        let machine = headTxt.includes("スマスロ") ? { name: "スマスロハナビ", bG: 20, def: L_HANABI_CONFIG } :
                      headTxt.includes("バーサス") ? { name: "バーサスリヴァイズ", bG: 28, def: VERSUS_CONFIG } :
                                                     { name: "新ハナビ", bG: 29, def: HANABI_CONFIG };
        document.getElementById('machine-disp').innerText = `${machine.name} (bG:${machine.bG})`;
        wl(`TARGET: ${machine.name} (定数:${machine.bG})`, "text-green-500 font-bold");

        st(5, "仮想配列（物流結合）");
        let uni = [...raws[0].lines];
        for(let i=1; i<raws.length; i++) {
            let last = uni[uni.length-1].text;
            let mIdx = raws[i].lines.findIndex(l => l.text === last);
            wl(`Image[${i}] Join at RAW#${mIdx}`);
            uni.push(...raws[i].lines.slice(mIdx + 1));
        }

        st(6, "定義表当て込み（現場検証）");
        let tG = parseInt(uni.find(l=>l.text.includes("G"))?.text.replace(/[,G]/g,'')) || 0;
        let bbL = uni.find(l => l.text.includes("回") && uni[uni.indexOf(l)+2]?.text.includes("/"));
        let bbC = bbL ? parseInt(bbL.text.replace(/[,回]/g,'')) : 0;
        let vcG = parseInt(uni.find(l=>l.text.includes("ハナビチャレンジ") && l.text.includes("G"))?.text.match(/(\d+)G/)?.[1]) || 0;
        let vgG = parseInt(uni.find(l=>l.text.includes("ハナビゲーム") && l.text.includes("G"))?.text.match(/(\d+)G/)?.[1]) || 0;
        
        let pLines = uni.filter(l => l.text.includes("/") && l.text.match(/\d/));
        let table = `<table><tr><th>項目</th><th>RAW</th><th>理論</th><th>採択</th></tr>`;
        let data = [];

        machine.def.forEach((slot, si) => {
            let anchor = pLines[si];
            if(!anchor) return;
            let uIdx = uni.indexOf(anchor);
            let rawK = -1;
            // 規律：2行上・3行上捜索
            for(let o of [2,3]) {
                let t = uni[uIdx-o];
                if(t && t.text.includes("回")) { rawK = parseInt(t.text.replace(/[,回]/g,'')); break; }
            }
            let pVal = parseFloat(anchor.text.split("/")[1]);
            let nRef = slot.type==="vc"?vcG : slot.type==="vg"?vgG : slot.type==="big"?bbC*machine.bG : tG;
            let theory = Math.round(nRef/pVal);
            let finalK = rawK;
            let res = false;
            // レスキュー
            if(rawK===-1 || (Math.abs(rawK-theory) > theory*0.5 && Math.abs(rawK-theory)>5)) { finalK = theory; res = true; }

            table += `<tr><td>${slot.name}</td><td>${rawK==-1?'欠':rawK}</td><td>${theory}</td><td class="${res?'rescue-text':'ok-text'}">${finalK}回</td></tr>`;
            data.push({...slot, k: finalK, n: nRef});
        });
        wl(table + `</table>`);

        st(7, "尤度計算（強度・Gap）");
        let lls = {1:0, 2:0, 5:0, 6:0};
        data.forEach(d => {
            if(!d.active) return;
            wl(`[${d.name}] K:${d.k}/N:${d.n}`, "text-amber-200 mt-1");
            [1,2,5,6].forEach(s => {
                let p = 1/d.probs[s];
                let thK = d.n * p;
                let gap = Math.abs(d.k - thK);
                let star = gap < (thK*0.05) ? "★★★★★" : gap < (thK*0.15) ? "★★★☆☆" : "★☆☆☆☆";
                let l = (d.k * Math.log(p) + (d.n - d.k) * Math.log(1 - p));
                lls[s] += l;
                wl(` S${s}: Th:${thK.toFixed(1)} | Gap:${gap.toFixed(1)} | ${star}`, "text-zinc-500 ml-2");
            });
        });

        st(8, "判別結果");
        let maxL = Math.max(...Object.values(lls));
        let sumE = Object.values(lls).reduce((a, c) => a + Math.exp(c - maxL), 0);
        document.getElementById('bars').innerHTML = "";
        [1,2,5,6].forEach(s => {
            let p = (Math.exp(lls[s] - maxL) / sumE) * 100;
            wl(`SETTING ${s}: <span class="text-white">${p.toFixed(2)}%</span>`);
            document.getElementById('bars').innerHTML += `<div><div class="flex justify-between text-[9px]"><span>${s}</span><span>${p.toFixed(1)}%</span></div><div class="bar-bg"><div class="bar-fill bg-amber-600" style="width:${p}%"></div></div></div>`;
        });
    } catch(e) { wl(`❌ ERROR: ${e.message}`, "text-red-500"); }
}
document.getElementById('file-input').onchange = e => run(e.target.files);
</script>
</body>
</html>