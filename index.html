<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rev 1.3.5 Unified Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Squada+One&display=swap');
        body { background-color: #0b0d11; color: #ffffff; font-family: 'Inter', sans-serif; height: 100dvh; display: flex; flex-direction: column; padding: 12px; margin: 0; overflow: hidden; }
        .kawaii-title { font-family: 'Squada One', cursive; background: linear-gradient(180deg, #00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2rem; text-align: center; line-height: 1; }
        .main-btn { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); border-radius: 12px; border: 2px solid #3b82f6; cursor: pointer; height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .log-area { flex-grow: 1; background: #000; border: 1px solid #00d2ff; border-radius: 8px; font-family: 'Share Tech Mono', monospace; font-size: 10px; overflow-y: auto; padding: 10px; position: relative; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background: #3b82f6; color: #fff; font-size: 9px; padding: 4px 8px; border-radius: 4px; z-index: 10; cursor: pointer; }
    </style>
</head>
<body>
    <div class="kawaii-title">TOTAL ANALYZER Rev 1.3.5</div>
    <div id="current-mode" class="text-[10px] text-cyan-400 text-center mb-2 italic">Waiting for input...</div>

    <label for="file-input" class="main-btn"><span>複数画像を選択・解析実行</span></label>
    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>

    <div id="result-area" class="bg-[#0f172a] rounded-xl p-3 border border-[#1e293b] mb-2">
        <div id="probs-container"></div>
    </div>

    <div class="log-area" id="log-container">
        <button class="copy-btn" id="copy-btn">COPY LOG</button>
        <div id="log">READY...</div>
    </div>

    <div class="flex gap-2 mt-2">
        <input type="password" id="api-key" class="bg-[#0f172a] border border-[#1e293b] text-white text-[12px] p-2 flex-grow rounded" placeholder="VISION API KEY">
        <button id="save-key" class="bg-blue-900 text-[11px] px-4 rounded text-white font-bold">SAVE</button>
    </div>

    <script>
        // --- 【聖域】最初期定義表マージ ---
        const L_HANABI_CONFIG = [
            { id: "total", name: "ボーナス合算", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "bb", name: "ビックボーナス", active: true, probs: {1: 297.9, 2: 292.6, 5: 284.9, 6: 273.1} },
            { id: "don", name: "ドンBB", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "red7", name: "赤七BB", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "rb", name: "レギュラーボーナス", active: true, probs: {1: 394.8, 2: 358.1, 5: 313.6, 6: 282.5} },
            { id: "f_tot", name: "風鈴合算", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "ba", name: "風鈴Ａ", active: true, probs: {1: 12.9, 2: 12.5, 5: 12.1, 6: 11.5} },
            { id: "bb_b", name: "風鈴Ｂ", active: true, probs: {1: 38.4, 2: 38.7, 5: 36.2, 6: 34.5} },
            { id: "i_tot", name: "氷合算", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "ia", name: "氷Ａ", active: true, probs: {1: 46.3, 2: 47.3, 5: 46.2, 6: 47.4} },
            { id: "ib", name: "氷Ｂ", active: false, probs: {1:1,2:1,5:1,6:1} },
            { id: "ca2", name: "チェリーＡ２", active: true, probs: {1: 21.0, 2: 19.4, 5: 20.5, 6: 19.6} },
            { id: "cb", name: "チェリーＢ", active: true, probs: {1: 307.7, 2: 306.2, 5: 300.6, 6: 297.9} },
            { id: "vc", name: "ハナビチャレンジ中ハズレ", active: true, probs: {1: 4.7, 2: 4.5, 5: 4.3, 6: 4.2} },
            { id: "vg", name: "ハナビゲーム中ハズレ", active: true, probs: {1: 6.4, 2: 6.0, 5: 5.4, 6: 5.4} },
            { id: "b_ba", name: "BIG中風鈴Ａ", active: true, probs: {1: 1.1, 2: 1.2, 5: 1.1, 6: 1.2} },
            { id: "b_bb", name: "BIG中風鈴Ｂ", active: true, probs: {1: 10.0, 2: 7.0, 5: 10.0, 6: 7.0} }
        ];

        const HANABI_CONFIG = [
            { id: "bb", name: "ビックボーナス", active: true, probs: {1: 277.7, 2: 268.6, 5: 256.0, 6: 248.2} },
            { id: "rb", name: "レギュラーボーナス", active: true, probs: {1: 356.2, 2: 331.0, 5: 306.2, 6: 280.1} },
            { id: "ba", name: "風鈴Ａ", active: true, probs: {1: 15.6, 2: 15.3, 5: 15.1, 6: 14.9} },
            { id: "bb_b", name: "風鈴Ｂ", active: true, probs: {1: 15.3, 2: 14.9, 5: 14.7, 6: 13.8} },
            { id: "ia", name: "氷Ａ", active: true, probs: {1: 54.6, 2: 59.6, 5: 51.2, 6: 54.6} },
            { id: "ca2", name: "チェリーＡ２", active: true, probs: {1: 21.0, 2: 19.3, 5: 20.6, 6: 19.9} },
            { id: "cb", name: "チェリーＢ", active: true, probs: {1: 282.5, 2: 281.3, 5: 276.5, 6: 274.2} },
            { id: "vc", name: "ハナビチャレンジ中ハズレ", active: true, probs: {1: 6.6, 2: 6.2, 5: 5.8, 6: 5.3} },
            { id: "vg", name: "ハナビゲーム中ハズレ", active: true, probs: {1: 11.7, 2: 10.8, 5: 10.0, 6: 9.4} },
            { id: "nf", name: "斜め風鈴", active: true, probs: {1: 11.0, 2: 9.0, 5: 11.0, 6: 9.0} }
        ];

        const VERSUS_CONFIG = [
            { id: "bb", name: "ビックボーナス合算", active: true, probs: {1: 292.6, 2: 284.9, 5: 275.4, 6: 264.3} },
            { id: "rb", name: "レギュラーボーナス", active: true, probs: {1: 374.5, 2: 341.3, 5: 319.7, 6: 292.6} },
            { id: "ba", name: "ベルＡ", active: true, probs: {1: 10.9, 2: 10.7, 5: 10.5, 6: 10.2} },
            { id: "bb_b", name: "ベルＢ", active: true, probs: {1: 20.9, 2: 21.2, 5: 20.3, 6: 20.6} },
            { id: "sa", name: "スイカＡ", active: true, probs: {1: 74.5, 2: 70.6, 5: 72.5, 6: 68.8} },
            { id: "cb", name: "チェリーＢ", active: true, probs: {1: 56.2, 2: 57.7, 5: 53.1, 6: 54.4} },
            { id: "vc", name: "バーサスチャンス中ハズレ", active: true, probs: {1: 5.0, 2: 4.9, 5: 4.6, 6: 4.5} },
            { id: "vg", name: "バーサスゲーム中ハズレ", active: true, probs: {1: 10.1, 2: 9.4, 5: 8.7, 6: 8.1} },
            { id: "cbs", name: "チェリー＋ベル揃い", active: true, probs: {1: 11.1, 2: 8.9, 5: 11.1, 6: 8.9} },
            { id: "cbh", name: "チェリー＋ベルはずれ", active: true, probs: {1: 256.0, 2: 128.0, 5: 256.0, 6: 128.0} }
        ];

        const clean = s => s.replace(/[！-～]/g, r => String.fromCharCode(r.charCodeAt(0) - 0xFEE0)).replace(/\s+/g, '');

        function addLog(msg, cls = "") {
            const d = document.createElement('div'); d.className = cls; d.innerHTML = msg;
            document.getElementById('log').appendChild(d);
            document.getElementById('log-container').scrollTop = document.getElementById('log-container').scrollHeight;
        }

        function getTargetIdx(raw, currentConfig) {
            const n = clean(raw);
            const mapper = {
                "bb": ["総BB", "ビックボーナス", "ビックボーナス合算"],
                "rb": ["レギュラーボーナス", "RB"],
                "ba": ["風鈴A", "風鈴Ａ", "ベルA", "ベルＡ"],
                "bb_b": ["風鈴B", "風鈴Ｂ", "ベルB", "ベルＢ"],
                "ia": ["氷A", "氷Ａ"], "sa": ["スイカA", "スイカＡ"],
                "ca2": ["チェリーA2", "チェリーＡ２"], "cb": ["チェリーB", "チェリーＢ"],
                "vc": ["ハナビチャレンジ中ハズレ", "HC中ハズレ", "バーサスチャンス中ハズレ"],
                "vg": ["ハナビゲーム中ハズレ", "HG中ハズレ", "バーサスゲーム中ハズレ"],
                "nf": ["斜め風鈴"], "cbs": ["チェリー+ベル揃い"], "cbh": ["チェリー+ベルはずれ"]
            };
            for(let [id, keys] of Object.entries(mapper)) {
                if(keys.some(k => n === clean(k))) return currentConfig.findIndex(c => c.id === id);
            }
            return -1;
        }

        async function processMulti(files) {
            const apiKey = document.getElementById('api-key').value;
            if(!apiKey) return alert("API KEY REQUIRED");
            document.getElementById('log').innerHTML = "";
            addLog(`[1] 画像情報: ${files.length}枚を検知`, "font-bold text-white");

            try {
                let allLines = [];
                for(let i=0; i<files.length; i++) {
                    const b64 = await new Promise(res => { const r = new FileReader(); r.onload = e => res(e.target.result.split(',')[1]); r.readAsDataURL(files[i]); });
                    const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`, {
                        method: 'POST',
                        body: JSON.stringify({ requests: [{ image: { content: b64 }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] })
                    });
                    const json = await res.json();
                    const anno = json.responses[0].textAnnotations;
                    const lines = anno.slice(1).reduce((acc, w) => {
                        let y = Math.round(w.boundingPoly.vertices[0].y / 10) * 10;
                        let x = w.boundingPoly.vertices[0].x;
                        let r = acc.find(v => v.y === y);
                        if(r) r.txt.push({x, t: w.description}); else acc.push({y, txt: [{x, t: w.description}]});
                        return acc;
                    }, []).sort((a,b)=>a.y-b.y).map(r => r.txt.sort((a,b)=>a.x-b.x).map(v=>v.t).join(" "));
                    allLines.push(lines);
                }

                // 機種判別
                let config = L_HANABI_CONFIG;
                let modeText = "新ハナビ";
                const flatText = allLines.flat().join("");
                if(flatText.includes("VERSUS") || flatText.includes("バーサス")) { config = VERSUS_CONFIG; modeText = "バーサスリヴァイズ"; }
                else if(flatText.includes("ハナビ") && !flatText.includes("新")) { config = HANABI_CONFIG; modeText = "5号機ハナビ"; }
                document.getElementById('current-mode').innerText = "MODE: " + modeText;

                addLog(`[2] OCR素情報抽出 & 機種判別: ${modeText}`, "font-bold text-white");
                let masterArray = config.map(() => ({ k: 0, sources: [] }));
                let totalG = 0;

                allLines.forEach((lines, imgIdx) => {
                    addLog(`<br>--- IMG_${imgIdx} RAW DATA ---`, "text-gray-400 underline");
                    lines.forEach((l, i) => {
                        addLog(`[Y:${i.toString().padStart(2,'0')}] ${l}`, "text-gray-500");
                        if(l.includes('G')) {
                            const gMatch = l.match(/(\d{1,3}(,\d{3})*|\d+)G/);
                            if(gMatch) totalG = parseInt(gMatch[1].replace(/,/g,''));
                        }
                        const pMatch = l.match(/1?\s*\/\s*([\d.]+)/);
                        if(pMatch && i >= 2) {
                            const val = parseInt(lines[i-2].replace(/,/g,''));
                            const idx = getTargetIdx(lines[i-1], config);
                            if(idx !== -1) masterArray[idx].sources.push({img: imgIdx, k: val, raw: lines[i-1]});
                        }
                    });
                });

                addLog(`<br>[3] 結合処理 & マッピング`, "font-bold text-white");
                masterArray.forEach((d, i) => {
                    if(d.sources.length > 0) {
                        d.k = d.sources[0].k;
                        addLog(`[SLOT_${i}] ${config[i].name} <- ${d.k}回 (IMG_${d.sources[0].img})`, "text-green-400");
                        d.sources.slice(1).forEach(s => {
                            if(s.k !== d.k) addLog(`  ⚠️矛盾: IMG_${s.img}では${s.k}回`, "text-red-500 font-bold");
                        });
                    }
                });

                // 尤度計算
                let lls = {1:0, 2:0, 5:0, 6:0};
                config.forEach((c, i) => {
                    if(c.active && masterArray[i].k > 0) {
                        let k = masterArray[i].k;
                        [1,2,5,6].forEach(s => {
                            let tp = 1/c.probs[s];
                            lls[s] += k * Math.log(tp) + (totalG - k) * Math.log(1-tp);
                        });
                    }
                });

                const max = Math.max(...Object.values(lls));
                const sumExp = Object.values(lls).reduce((a, b) => a + Math.exp(b - max), 0);
                document.getElementById('probs-container').innerHTML = [1,2,5,6].map(s => {
                    const prob = (Math.exp(lls[s]-max) / sumExp) * 100;
                    return `<div class="mb-2"><div class="flex justify-between text-[11px]"><span>設定${s}</span><span>${prob.toFixed(1)}%</span></div>
                            <div class="bar-bg w-full bg-black rounded-full h-2 mt-1"><div class="h-full bg-blue-500 rounded-full" style="width:${prob}%"></div></div></div>`;
                }).join("");
                addLog(`<br>解析終了: ${totalG}G`, "text-cyan-400 font-bold");

            } catch (e) { addLog(`ERROR: ${e.message}`, "text-red-500"); }
        }

        document.getElementById('copy-btn').onclick = () => { navigator.clipboard.writeText(document.getElementById('log').innerText); alert("COPIED"); };
        document.getElementById('save-key').onclick = () => { localStorage.setItem('v_key', document.getElementById('api-key').value); alert("SAVED"); };
        window.onload = () => { document.getElementById('api-key').value = localStorage.getItem('v_key') || ""; };
        document.getElementById('file-input').onchange = e => processMulti(e.target.files);
    </script>
</body>
</html>