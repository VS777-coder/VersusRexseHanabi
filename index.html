<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>みおのデバッグ 1.1.8-DEBUG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d0f14; color: #ffffff; font-family: 'Share Tech Mono', monospace; height: 100dvh; width: 100vw; padding: 12px; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box; }
        .main-btn { background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); border-radius: 12px; border: 2px solid #fff; }
        .future-log { background-color: #000; border: 1px solid #00ffcc; border-radius: 12px; padding: 12px; font-size: 10px; color: #00ffcc; height: 75vh; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; line-height: 1.2; box-shadow: inset 0 0 15px rgba(0,255,204,0.2); }
        .debug-tag { background: #333; color: #fff; padding: 2px 4px; border-radius: 4px; font-size: 9px; margin-right: 4px; }
        .error-tag { background: #800; color: #fff; padding: 2px 4px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="w-full shrink-0 mb-3 max-w-md mx-auto">
        <label for="file-input" class="main-btn w-full py-4 text-white font-black text-xl flex items-center justify-center text-center cursor-pointer">
            ユニメモ<br>全ログ出力デバッグ
        </label>
        <input type="file" id="file-input" class="hidden" accept="image/*">
    </div>

    <div id="log" class="future-log w-full max-w-md mx-auto">
        【デバッグ待機中】
        画像をアップロードすると、スマホ内部での処理過程がすべてここに表示されます。
    </div>

    <input type="password" id="api-key" class="hidden">

    <script>
        const MASTER_CONFIG = {
            "VERSUS": { bb: { key: "BB" }, rb: { key: "RB" }, ba: { key: "ベル\\s*A" }, sa: { key: "スイカ\\s*A" }, total: { key: "総\\s*プレイ\\s*数" } },
            "HANABI": { bb: { key: "BB" }, rb: { key: "RB" }, ba: { key: "\\nA\\s+1" }, sa: { key: "氷\\s*A" }, total: { key: "総\\s*プレイ\\s*数" } }
        };

        function debugExtract(rawText, threshold) {
            const logArea = document.getElementById('log');
            let debugOut = `[SYSTEM] Dynamic Threshold: ${threshold.toFixed(2)}px\n\n`;
            debugOut += `[RAW SORTED TEXT]\n------------------\n${rawText}\n------------------\n\n`;

            const mode = (rawText.includes("ハナビ") || rawText.includes("ハナ ビ")) ? "HANABI" : "VERSUS";
            debugOut += `[MODE] Detected: ${mode}\n\n`;

            const config = MASTER_CONFIG[mode];
            debugOut += `[REGEX MATCHING LOG]\n`;

            for (let id in config) {
                const item = config[id];
                const regex = new RegExp(`${item.key}[\\s\\S]{0,100}?`);
                const match = rawText.match(regex);
                if (match) {
                    debugOut += `✅ [${id}] Match: "${match[0].replace(/\n/g, ' [NL] ')}"\n`;
                    const nums = match[0].match(/[\d,.]+/g);
                    debugOut += `   -> Extracted Numbers: ${nums ? nums.join(', ') : 'NONE'}\n`;
                } else {
                    debugOut += `❌ [${id}] No match found for key: "${item.key}"\n`;
                }
            }
            logArea.innerText = debugOut;
        }

        if(localStorage.getItem('v_key')) document.getElementById('api-key').value = localStorage.getItem('v_key');
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                const res = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${document.getElementById('api-key').value}`, {
                    method: 'POST',
                    body: JSON.stringify({ requests: [{ image: { content: reader.result.split(',')[1] }, features: [{ type: 'DOCUMENT_TEXT_DETECTION' }] }] }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const json = await res.json();
                const ann = json.responses[0]?.textAnnotations;
                if (ann) {
                    const items = ann.slice(1).map(a => ({ text: a.description, x: (a.boundingPoly.vertices[0].x + a.boundingPoly.vertices[2].x) / 2, y: (a.boundingPoly.vertices[0].y + a.boundingPoly.vertices[2].y) / 2 }));
                    const maxY = Math.max(...items.map(it => it.y));
                    const minY = Math.min(...items.map(it => it.y));
                    const dynamicThreshold = (maxY - minY) * 0.015;

                    items.sort((a, b) => a.y - b.y);
                    let rows = [], cur = [items[0]];
                    for (let i = 1; i < items.length; i++) {
                        if (Math.abs(items[i].y - cur[0].y) < dynamicThreshold) cur.push(items[i]);
                        else { rows.push(cur); cur = [items[i]]; }
                    }
                    rows.push(cur);
                    const rawText = rows.map(r => r.sort((a, b) => a.x - b.x).map(it => it.text).join(' ')).join('\n');
                    debugExtract(rawText, dynamicThreshold);
                }
            };
        };
    </script>
</body>
</html>